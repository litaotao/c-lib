
function Comment(options)
{if(!arguments.length)return;this.options=options||{};this.options.main=options.main||$('.main_wrap');this.options.closefloatlayer=commentConfig.closefloatlayer||false;this.options.commentCallBack=options.commentCallBack||null;this.options.commentPageCallBack=options.commentPageCallBack||null;this.options.shareCallBack=options.shareCallBack||null;this.options.cmtsmtCallBack=options.cmtsmtCallBack||null;this.options.cmtcancelCallBack=options.cmtcancelCallBack||null;this.options.godcommentCallBack=options.godcommentCallBack||null;this.options.screenScroll=0;this.sending=0;commentConfig.comt=commentConfig.comt||{};commentConfig.comt.comt_num=commentConfig.comt.comt_num||'0';commentConfig.comtTitle=commentConfig.comtTitle||'说说你的看法...';commentConfig.comt.show=commentConfig.comt.show||false;commentConfig.share=commentConfig.share||{};commentConfig.share.show=commentConfig.share.show||false;commentConfig.logout=commentConfig.logout||{};commentConfig.logout.switchurl=commentConfig.logout.switchurl||'';commentConfig.logout.logouturl=commentConfig.logout.logouturl||'';commentConfig.short=commentConfig.short||{};commentConfig.short.ifShortDisplay=commentConfig.short.ifShortDisplay||false;commentConfig.user=commentConfig.user||{};commentConfig.user.usernick=commentConfig.user.usernick||'';commentConfig.user.userface=commentConfig.user.userface||'';commentConfig.suda=commentConfig.suda||'comment';var ua=window.navigator.userAgent.toLowerCase();this._addcss();this._createDOM();this._addEvent();}
var oMeta=document.getElementsByName('viewport')[0];Comment.prototype._addcss=function(){var oLink=document.createElement('link');oLink.rel='stylesheet';oLink.type='text/css';oLink.href='http://mjs.sinaimg.cn/wap/module/short_comment/201408271704/css/addComment.css';document.getElementsByTagName('head')[0].appendChild(oLink);}
Comment.prototype._createDOM=function()
{window._this=this;var arr=[];if(!this.options.closefloatlayer){arr.push('<aside>');arr.push('<div class="foot_comment">');arr.push('<div class="foot_commentcont">');arr.push('<div class="foot_cmt_input j_cmt_btn" data-sudaclick="'+commentConfig.suda+'_cmt_btn"><p>'+commentConfig.comtTitle+'</p>');arr.push('</div>');if(commentConfig.comt.show){arr.push('<div class="foot_cmt_num j_p_comt">');arr.push('<a href="'+commentConfig.comt.url+'" title="" data-sudaclick="'+commentConfig.suda+'_comt">');arr.push('<span class="cmt_num_t">'+commentConfig.comt.comt_num+'</span></a></div>');}
if(!commentConfig.user.usernick){if(commentConfig.share.show){arr.push('<div class="foot_cmt_share j_p_share" id="sharebox">');arr.push('<a data-href="'+commentConfig.share.url+'" title="" data-sudaclick="'+commentConfig.suda+'_share">');arr.push('<span class="cmt_share" id="uclogin">分享</span>');arr.push('</a></div>');}}
else{if(commentConfig.share.show){arr.push('<div class="foot_cmt_share j_p_share">');arr.push('<a href="'+commentConfig.share.url+'" title="" data-sudaclick="'+commentConfig.suda+'_share">');arr.push('<span class="cmt_share">分享</span>');arr.push('</a></div>');}}
if(!commentConfig.comt.show&&!commentConfig.share.show&&!commentConfig.short.ifShortDisplay){arr.push('<div class="foot_cmt_num j_cmt_btn">');arr.push('<a href="javascript:;" title="">');arr.push('<span class="cmt_num_t" data-sudaclick="'+commentConfig.suda+'_cmt_btn">'+commentConfig.comt.comt_num+'</span></a></div>');}
if(commentConfig.short.ifShortDisplay){var url=commentConfig.short.shorturl,id=commentConfig.short.id;if(!!url==false){return false;}
if(url.indexOf('?')==-1){url=url+'?';}
var loadUrl=url+'id='+id+'&jsoncallback=callbackShort';$.ajax({url:loadUrl,async:false,type:'GET',dataType:'jsonp',success:function(data){},error:function(xhr,type){}});window.callbackShort=function(rs){if(rs.status){var data=rs.data;var len=data.length,arr=[];if(len>0){arr.push('<div class="foot_cmt_god j_god_btn" data-sudaclick="'+commentConfig.suda+'_god_btn">');arr.push('<p>神短评</p></div>');arr.push('<div class="god_comment_box">');arr.push('<span class="god_comment_notice">点击“短评标签”帮你快速神评论</span>');arr.push('<div class="god_comment">');for(var i=0;i<len;i++){if(data[i].colour!='#ffffff'&&data[i].colour!='#fff'&&data[i].colour){arr.push('<span style="background:'+data[i].colour+';color:#ffffff;" data-sudaclick="'+commentConfig.suda+'_god"><strong class="god_word">'+data[i].content+'</strong><em><i class="god_count">'+data[i].count+'</i></em></span>');}
else{arr.push('<span style="background:'+data[i].colour+';" data-sudaclick="'+commentConfig.suda+'_god"><strong class="god_word" >'+data[i].content+'</strong><em><i class="god_count">'+data[i].count+'</i></em></span>');}}
arr.push('</div>');arr.push('<span class="god_comment_notice tips">登录后,发表7字以内短评论，有机会上墙哦！</span>');arr.push('<span class="god_close_ico"><b></b></span>');arr.push('</div>');}
else{if(commentConfig.short.second){for(i in commentConfig.short.second){if(i=='comt'){var seconddata=commentConfig.short.second[i];arr.push('<div class="foot_cmt_num j_p_comt">');arr.push('<a href="'+seconddata.url+'" title="" data-sudaclick="'+commentConfig.suda+'_comt">');arr.push('<span class="cmt_num_t">'+seconddata.comt_num+'</span></a></div>');}}}
else{arr.push('<div class="foot_cmt_num j_cmt_btn">');arr.push('<a href="javascript:;" title="">');arr.push('<span class="cmt_num_t" data-sudaclick="'+commentConfig.suda+'_cmt_btn">'+commentConfig.comt.comt_num+'</span></a></div>');}}
$(arr.join('')).insertAfter($('.j_cmt_btn'));window._this._addGod();}else{alert(rs.message);}}}
arr.push('</div></div></aside>');}
if(!commentConfig.user.usernick){arr.push('<div class="cmnt_pop"  id="j_cmnt_pop">');arr.push('<div class="cmnt_wrap">');arr.push('<div class="cmnt_tp">');arr.push('<span class="fl"><a href="javascript:void(0);" class="cmnt_cancel" id="j_cmnt_cancel" data-sudaclick="'+commentConfig.suda+'_send_cancel">取消</a></span>');arr.push('<span class="fr"><a href="javascript:void(0);" class="cmnt_smt" id="j_cmnt_smt" data-sudaclick="'+commentConfig.suda+'_send_cmnt">发送</a></span>');arr.push('</div>');arr.push('<div class="cmnt_login unlogin">');arr.push('<span class="fl" id="btnBox">');arr.push('<a class="login" href="javascript:;" id="uclogin">登录</a>');arr.push('<code>(你的微博、新浪账号)</code></span>');arr.push('<span class="fr">');arr.push('<a href="'+commentConfig.login.signup+'">注册</a>');arr.push('</span></div>');arr.push('<div class="cmntarea">');arr.push('<textarea id="j_cmnt_input" class="newarea" name="" placeholder="说说你的看法..."></textarea>');arr.push('</div>');arr.push('</div></div>');}
else{arr.push('<div class="cmnt_pop"   id="j_cmnt_pop">');arr.push('<div class="cmnt_wrap">');arr.push('<div class="cmnt_tp">');arr.push('<span class="fl"><a href="javascript:void(0);" class="cmnt_cancel" id="j_cmnt_cancel" data-sudaclick="'+commentConfig.suda+'_send_cancel">取消</a></span>');arr.push('<span class="fr"><a href="javascript:void(0);" class="cmnt_smt" id="j_cmnt_smt" data-sudaclick="'+commentConfig.suda+'_send_cmnt">发送</a></span>');arr.push('</div>');if(commentConfig.user.usernick&&commentConfig.logout.switchurl){arr.push('<div class="cmnt_login">');arr.push('<span class="fl"><img src="'+commentConfig.user.userface+'">'+commentConfig.user.usernick+'</span>');arr.push('<span class="fr"><a href="'+commentConfig.logout.switchurl+'">切换账号</a>&nbsp;&nbsp;&nbsp;/&nbsp;&nbsp;&nbsp;<a href="'+commentConfig.logout.logouturl+'">登出</a>');arr.push('</span></div>');}
arr.push('<div class="cmntarea">');arr.push('<textarea id="j_cmnt_input" class="newarea" name="" placeholder="说说你的看法..."></textarea>');arr.push('</div>');arr.push('<div class="cmnt_bm">');arr.push('<span class="fl"><input type="checkbox" id="j_wb_sendcont" name="" value="1">&nbsp;&nbsp;同时转发到微博</span>');arr.push('</div></div></div>');}
arr.push('<aside id="tipsCeng" class="tipsCeng">');arr.push('<div class="comment_remind animation_marker">');arr.push('<p class="marker_t">您已发送成功！</p>');arr.push('</div>');arr.push('</aside>');arr.push('<div class="god_bg"></div>');$('body').append(arr.join(''));}
Comment.prototype._addEvent=function()
{this.oShare=$('.j_p_share'),this.oComment=$('.j_p_comt'),this.oCmtText=$('.j_cmt_btn'),this.oCmtArea=$('#j_cmnt_pop'),this.oMainWrap=this.options.main,this.oCmtcancel=$('#j_cmnt_cancel'),this.oCmtsmt=$('#j_cmnt_smt'),this.oSucTips=$('#tipsCeng'),this.oreplybtn=$('.replybtn'),this.oTextarea=$('#j_cmnt_input'),this.owb_ico=$('.wb_ico');this.oFoot_comment=$('.foot_comment');this.oCmnt_login=$('.cmnt_login');this.focusStatus=0;oViedo=$('video');var _this=this;if(commentConfig.user.usernick!=''&&commentConfig.user.userface==''){var url='http://passport.sina.cn/sso/islogin?entry=wapsso&';jsonp(url,{},function(re){_this.oCmnt_login.find('img').attr('src',re.data.portrait_url);});}
if(commentConfig.user.usernick){var windowHeight=223;}
else{var windowHeight=193;}
this.oCmtArea.prepend('<div id="blankBox" style="width:100%; height:'+(document.documentElement.clientHeight-windowHeight+10)+'px;"></div>');if(window.navigator.userAgent.toLowerCase().indexOf('ucbrowser')==-1){}
else{this.oCmtArea.css('paddingBottom',20+'px');}
this.oShare_layer=$('#sharebox');if(this.oShare_layer.length>0){this.oShare_layer.on('click',function(){if(oViedo.length>0){if(oViedo[0].getBoundingClientRect().bottom>0){_this.god_scroll=document.body.scrollTop;window.scrollTo(0,document.body.scrollTop+oViedo[0].getBoundingClientRect().bottom);}}
window.removeEventListener("touchmove",prevent,false);_this.oFoot_comment.hide();_this.oGod_box.hide();_this.oGod_bg.hide();});}
if(this.oComment.length>0){this.oComment.on('click',function(){location.href=oComment.find('a').attr('href');_this.options.commentPageCallBack&&_this.options.commentPageCallBack();});}
if(this.oCmtText.length>0){this.oCmtsmt.on('click',function(){if(!_this.sending){_this.sending=1;_this.options.cmtsmtCallBack&&_this.options.cmtsmtCallBack(_this.oTextarea[0].value,_this._commentSuccess,_this);}});}
if(this.oCmtText.length>0){$('.foot_comment').on('click tap','.j_cmt_btn',function(){_this.commentShow();})}
this.oTextarea.on('change',function(){try
{localStorage.textarea=this.value;}
catch(e)
{}})
if(this.oCmtcancel.length>0){this.oCmtcancel.on('click',function(){_this.commentHide();_this.options.cmtcancelCallBack&&_this.options.cmtcancelCallBack();});}
(function(w,doc){var $=function(id){return doc.getElementById(id);},addEvent=doc.addEventListener?function(elem,type,fn){elem.addEventListener(type,fn,false);}:function(elem,type,fn){elem.attachEvent('on'+type,fn);},nodes={};if(w["SINA_OUTLOGIN_LAYER"]){loginLayer=w["SINA_OUTLOGIN_LAYER"];loginLayer.set('sso',{entry:'wapsso'}).init();if($('btnBox')){addEvent($('btnBox'),'click',function(ev){loginLayer.show();window.scrollTo(0,12);window.loginActive='btnBox';});}
if($('sharebox')){addEvent($('sharebox'),'click',function(){loginLayer.show();window.loginActive='sharebox';});}
loginLayer.register("login_success",function(){if(window.loginActive=='btnBox'){window.location.href=window.location.href;}
if(window.loginActive=='sharebox'){window.location.href=$('sharebox').children[0].dataset.href;}});loginLayer.register("layer_hide",function(){});}})(window,document);setTimeout(function(){window.addEventListener("scroll",function(){if(_this.oCmtArea.css('display')=='none'){if($('#showpic_box').length>0){if($('#showpic_box').hasClass('hide')){_this.oFoot_comment.show();}}
else if($('.J-slider').length>0){}
else{_this.oFoot_comment.show();}}},false)},500)}
Comment.prototype._addGod=function(){this.oGod=$('.j_god_btn');this.oGod_box=$('.god_comment_box');this.oGod_bg=$('.god_bg');this.oClose_ico=$('.god_close_ico');this.aGod_comment=$('.god_comment span');oViedo=$('video');var _this=this;if(this.oGod.length>0){this.oGod.on('click',function(){if(_this.oGod_box.css('display')=='none'){if(oViedo.length>0){if(oViedo[0].getBoundingClientRect().bottom>0){_this.god_scroll=document.body.scrollTop;window.scrollTo(0,document.body.scrollTop+oViedo[0].getBoundingClientRect().bottom);}}
_this.oGod_box.show();_this.oGod_bg.show();window.addEventListener("touchmove",prevent,false);}
else{if(_this.god_scroll){window.scrollTo(0,_this.god_scroll);_this.god_scroll=0;}
_this.oGod_box.hide();_this.oGod_bg.hide();window.removeEventListener("touchmove",prevent,false);}});}
if(this.oGod_bg.length>0){this.oGod_bg.on('click',function(){if(_this.god_scroll){window.scrollTo(0,_this.god_scroll);_this.god_scroll=0;}
_this.oGod_box.hide();_this.oGod_bg.hide();window.removeEventListener("touchmove",prevent,false);})}
if(this.oClose_ico.length>0){this.oClose_ico.on('click',function(){if(_this.god_scroll){window.scrollTo(0,_this.god_scroll);_this.god_scroll=0;}
_this.oGod_box.hide();_this.oGod_bg.hide();window.removeEventListener("touchmove",prevent,false);})}
if(this.aGod_comment.length>0){this.aGod_comment.on('click',function(){if(!_this.sending){_this.sending=1;$(this).find('em').append('<i class="god_comment_fly"></i>');$(this).find('.god_count').html($(this).find('.god_count').html()-0+1);setTimeout(function(){$('.god_comment_fly').remove();},600)
_this.options.godcommentCallBack&&_this.options.godcommentCallBack(_this._godSuccess,_this,this);}})}}
function changSize(){var docHeight=document.documentElement.clientHeight;var commentH=223;$('#j_cmnt_pop').css('paddingTop',docHeight-commentH);}
function prevent(e){e.preventDefault();return;}
Comment.prototype.commentShow=function(){this.options.commentCallBack&&this.options.commentCallBack();this.options.screenScroll=document.body.scrollTop||document.documentElement.scrollTop;if($('.god_comment_box').length>0){this.oGod_box.hide();this.oGod_bg.hide();}
if(this.oMainWrap.length>1){for(var i=0;i<this.oMainWrap.length;i++){this.oMainWrap[i].hide();}}
else if(this.oMainWrap.length==1){this.oMainWrap.hide();}
else{return;}
this.oFoot_comment.hide();this.oCmtArea.show();this.oTextarea.focus();oMeta.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, minimal-ui";window.scrollTo(0,1);try
{localStorage.test='1';if(localStorage.textarea){this.oTextarea[0].value=localStorage.textarea;}}
catch(e)
{}}
Comment.prototype._commentSuccess=function(){this.oTextarea[0].value='';this.oTextarea[0].placeholder='说说你的看法...';this.oSucTips.show();_this=this;window.scrollTo(0,12);setTimeout(function(){_this.sending=0;_this.oSucTips.hide();_this.oCmtArea.hide();if(_this.oMainWrap.length>1){for(var i=0;i<_this.oMainWrap.length;i++){_this.oMainWrap[i].show();}}
else if(_this.oMainWrap.length==1){_this.oMainWrap.show();}
else{return;}
_this.oFoot_comment.show();window.scrollTo(0,_this.options.screenScroll);oMeta.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no";},1500)
try
{localStorage.textarea='';}
catch(e)
{}}
Comment.prototype._godSuccess=function(){this.oSucTips.show();_this=this;setTimeout(function(){_this.sending=0;if(_this.god_scroll){window.scrollTo(0,_this.god_scroll);_this.god_scroll=0;}
_this.oGod_bg.hide();_this.oSucTips.hide();_this.oGod_box.hide();_this.oGod_bg.hide();window.removeEventListener("touchmove",prevent,false);},1500)}
Comment.prototype.commentHide=function(){this.oCmtArea.hide();if(this.oMainWrap.length>1){for(var i=0;i<this.oMainWrap.length;i++){this.oMainWrap[i].show();}}
else if(this.oMainWrap.length==1){this.oMainWrap.show();}
else{return;}
try
{localStorage.textarea='';}
catch(e)
{}
this.oFoot_comment.show();this.oTextarea[0].value='';window.scrollTo(0,this.options.screenScroll);oMeta.content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no";}
function jsonp(url,data,fnSucc)
{var fnName='jsonp_'+Math.random();fnName=fnName.replace('.','');window[fnName]=function(arg)
{fnSucc&&fnSucc(arg);oHead.removeChild(oS);window[fnName]=null;};data.callback=fnName;var arr=[];for(var i in data)
{arr.push(i+'='+encodeURIComponent(data[i]));}
var sData=arr.join('&');var oS=document.createElement('script');oS.src=url+sData;var oHead=document.getElementsByTagName('head')[0];oHead.appendChild(oS);}