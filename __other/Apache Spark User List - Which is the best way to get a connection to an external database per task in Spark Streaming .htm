<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- saved from url=(0157)http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-td8937.html -->
<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
					
					<link rel="stylesheet" href="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/nabble.pack.css" type="text/css">
	<link rel="stylesheet" href="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/NamlServlet.jtp" type="text/css">
					<script defer="" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/s1.js"></script><script type="text/javascript" async="" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/ga.js"></script><script src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/jquery-1.7.2.pack.js" type="text/javascript"></script><style type="text/css"></style>
	<script src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/nabbledropdown-2.4.1.pack.js" type="text/javascript"></script>
	<script src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/NamlServlet(1).jtp" type="text/javascript"></script>
					<script type="text/javascript">
		var terms = Nabble.getSearchTerms();
		var hasTurnOff = false;
		Nabble.searchHighlight = function($elem) {
			if (terms != null && terms.length > 0) {
				$elem.each(function() {
					Nabble.highlightSearchTerms(terms, this);
				});
				if (Nabble.hasHighlightedTerms && !hasTurnOff) {
					var turnOffLink = '<span id="turn-off-highlight-control"><span class="highlight">&nbsp;X&nbsp;</span> ';
					turnOffLink += '<a href="javascript:void(0)" onclick="Nabble.turnOffHighlight()">Turn off highlighting</a></span>';
					$('#topics-controls-right').prepend(turnOffLink);
					hasTurnOff = true;
				}
			}
		};
		Nabble.turnOffHighlight = function() {
			Nabble.deleteCookie("query");
			Nabble.deleteCookie("searchuser");
			Nabble.deleteCookie("searchterms");
			$('span.search-highlight').removeClass('bold highlight');
			$('#turn-off-highlight-control').hide();
		};
	</script>
	<script type="text/javascript">
		Nabble.messageTextWidth();
	</script>
			<script type="text/javascript"> $(document).ready(function() { Nabble.searchHighlight($('h2.post-subject,div.message-text')); }); </script> <script type="text/javascript"> var _hash = Nabble.hash(); if (_hash) { (function(){ var post = _hash.substr(2); var allPosts = [8937, 8977, 9009, 9012, 9017, 9117, 9156]; var allURLs = ["/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-td8937.html"]; var iPost = allPosts.indexOf(parseInt(post)); var lower = 0; var upper = lower + 20; if (iPost != -1 && (iPost < lower || iPost >= upper)) location.replace(allURLs[Math.floor(iPost/20)]+_hash); })(); } $(document).ready(function() { var rootId = '8937'; var currentPostId = rootId; var isChangingViews = _hash == '#none'; if (_hash && !isChangingViews) currentPostId = _hash.substr(2); Nabble.hideQuotes(); function scrollToSelectedPost() { var $arrow = $('#red-arrow'+currentPostId).show(); if ($arrow.size() > 0) { var isRootPost = currentPostId == rootId; if (Nabble.isEmbedded) { if (Nabble.canScroll()) scrollTo(0, 0); var y = isChangingViews? null : isRootPost? 1 : $arrow.parents('div.classic-row').offset().top; Nabble.resizeFrames('', y); } else if (Nabble.canScroll() && !isRootPost) { var yPos = $arrow.offset().top; scrollTo(0,yPos-20); } } else { if (Nabble.isEmbedded && Nabble.canScroll()) { Nabble.resizeFrames('', 1); } else { var tb = $('div.top-bar').get(0); if (tb) tb.scrollIntoView(); } } }; $(window).load(scrollToSelectedPost); if (Nabble.isEmbedded) { $('div.message-text img').load(Nabble.resizeFrames); } }); </script> <style type="text/css"> div.classic-header { height:2.2em; clear:both; overflow:hidden; } div.classic-author-name { float:left; width: 140px; overflow: hidden; text-align:center; font-weight:bold; } div.classic-subject-line { left:.5em; overflow:hidden; height:1.3em; position:relative; } div.classic-right-menu { float:right; padding-left:1em; } div.classic-bar { padding:.5em .3em; clear:both; height:1.8em; } table.classic-body { border-collapse:collapse; margin-bottom:1em; table-layout: fixed; width:100%; } td.classic-author { vertical-align: top; text-align:center; width:140px; padding-bottom:1em; } td.classic-message { vertical-align:top; padding:1em; } div.message-text { cursor:text; overflow-x:auto; } div.avatar-inner { margin-left:20px; } div.avatar-outer { width:140px; text-align:left; } div.avatar-label { white-space:nowrap; font-size:80%; } </style>

	<title>Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming?</title>
			<meta name="description" content="Which is the best way to get a connection to an external database per task in Spark Streaming?. Hi list, I&#39;m writing a Spark Streaming program that reads from a kafka topic, performs some...">
			<meta name="keywords" content="which, best, way, get, connection, external, database, per, task, spark, streaming, list, writing, program, reads, kafka, topic, performs, some, transformations, data, then, inserts, each, record, with, foreachrdd, apache, user">
			<style type="text/css">
			#search-box-dropdown {
				text-align:left;
				position:absolute;
				display:none;
				z-index:1000;
				overflow:hidden;
			}
		</style>
		<script type="text/javascript">
			$(document).ready(function() {
				var $sdd = $('#search-box-dropdown');
				var $sb = $('#search-input');
				var $form = $sb.parent();
				var timeout;
				$(document).click(function(o){
					var $target = $(o.target);
					if ($target.parents().hasClass('search-box-dropdown')) {
						clearTimeout(timeout);
						$sb.focus();
					}
				});
				$sb.focusin(function(e) {
					$sdd.css('left', $sb.position().left - 5);
					$sdd.width($sb.outerWidth() + 10);
					$sdd.show();
				});
				$sb.focusout(function() {
					timeout = setTimeout(function() {
						$sdd.hide();
					},250);
				});
				$('input[type=radio]', $sdd).change(function() {
					var nodeId = $(this).val();
					$('input[name="node"]', $form).val(nodeId);
				});
				$('input[name="node"]', $form).val(1);
			});
		</script><script type="text/javascript">
			Nabble.setView = function(view,url,post) {
				Nabble.setVar("tview",view);
				url += Nabble.getClientID(';');
				if (url.indexOf('#') == -1)
					url += '#none';
				location.replace(url);
			};
		</script><style type="text/css"> div.nabble-tooltip, div.nabble-tooltip * { color: #EEE; font-weight:bold; } div.nabble-tooltip { background: #000; font-size:90%; line-height:normal; display: none; position: absolute; z-index: 88888; padding: .5em; border: 1px solid #FFF; white-space:normal; -moz-border-radius: 3px; -webkit-border-radius: 3px; border-radius: 3px; } div.nabble-tooltip-small-row, div.nabble-tooltip-small-row * { color:#D0EAF2; } div.nabble-tooltip-small-row { font-size:80%; font-weight:normal; padding-top: .4em; } div.nabble-tooltip-arrow { font: 40px Arial, Sans-serif; line-height:1em; left:15px; position:absolute; bottom:-15px; height:15px; width:30px; overflow:hidden; } div.nabble-tooltip-arrow div { position:absolute; } div.nabble-tooltip-arrow div.d1 { top:-22px; color: #FFF; } div.nabble-tooltip-arrow div.d2 { top:-25px; color: #000; } </style> <script type="text/javascript"> Nabble.startTooltip = function(e, position, delay) { if (e.nabbletooltip) return; e.nabbletooltip = true; var $this = $(e); var $arrow = $this.children().last(); var $elem = $this.prev(); $elem.hover( function() { setTip(); setTimer(); }, function() { stopTimer(); $this.hide(); } ); function setTimer() { $this.showTipTimer = setTimeout(function() { $('div.nabble-tooltip').hide(); stopTimer(); $this.fadeTo('fast', .8); }, delay); }; function stopTimer() { clearInterval($this.showTipTimer); }; function setTip(){ if ($this.parent().get() != document.body) $(document.body).append($this); var useTitle = $this.attr('use_title') == 'true'; if (useTitle) { var title = $elem.attr('title'); if (title != '') { $arrow.remove(); $this.html(title); $elem.attr('title',''); $this.append($arrow); } } var win = $(window).width(); if (position == 'up') { var w = $this.outerWidth(); if (w > 250) { w = 250; $this.width(w); } var xMid = $elem.offset().left + $elem.outerWidth()/2; var xTip = xMid - w/2; if (xTip+w > win-5) xTip = win-w-5; if (xTip < 0) xTip = 0; var xArrow = xMid-xTip-11; var yTip = $elem.offset().top-$this.outerHeight()-12; $arrow.css('left', xArrow); $this.css({'top' : yTip, 'left' : xTip}); } else if (position == 'right') { var h = $this.outerHeight(); var yMid = $elem.offset().top + $elem.outerHeight()/2; var yTip = yMid - h/2; var xTip = $elem.offset().left + $elem.outerWidth() + 10; $arrow.width(8).height(24).css({bottom:0,left:-8}); var yArrow = (h - 24)/2; $arrow.css({top:yArrow}); var $d1 = $arrow.children().first(); var $d2 = $arrow.children().last(); $d1.css({top:-11}); $d2.css({top:-11,left:1}); $this.css({'top' : yTip, 'left' : xTip}); } }; }; </script><script type="text/javascript">
			Nabble.pinTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=pin_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#pin-icon').show();
					NabbleDropdown.show('unpinTopic');
					NabbleDropdown.hide('pinTopic');
					alert('This topic has been pinned.');
				});
			};
		</script><script type="text/javascript">
			Nabble.unpinTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=unpin_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#pin-icon').hide();
					NabbleDropdown.hide('unpinTopic');
					NabbleDropdown.show('pinTopic');
					alert('This topic has been unpinned.');
				});
			};
		</script><script type="text/javascript">
			Nabble.lockTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=lock_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#lock-icon').show();
					NabbleDropdown.show('unlockTopic');
					NabbleDropdown.hide('lockTopic');
					alert('This topic has been locked.');
				});
			};
		</script><script type="text/javascript">
			Nabble.unlockTopic = function(id) {
				var call = '/template/NamlServlet.jtp?macro=unlock_topic&node=' + id + Nabble.getClientID();
				$.getScript(call, function() {
					$('#lock-icon').hide();
					NabbleDropdown.hide('unlockTopic');
					NabbleDropdown.show('lockTopic');
					alert('This topic has been unlocked.');
				});
			};
		</script><script type="text/javascript" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/LoadUnit.jtp"></script><script src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/LoadUnit(1).jtp"></script>
			<script type="text/javascript">
				Nabble.adbayes();
			</script><script type="text/javascript">
			Nabble.nViews = function(id, views) {
				var $v = $('#v'+id);
				var pos = views=='1'?0:1;
				var t = $v.html()? $v.html().split('|')[pos]:'';
				$v.html(t == ''? views : t.replace(/%1/g,views)).show();
			};
		</script><style type="text/css">
			img.report-flag {
				vertical-align:middle;
				cursor: pointer;
			}
			#report-inappropriate-content {
				position: fixed;
				z-index:9999;
				display:none;
				padding:1.5em;
				left:8%;
				right:8%;
				top:8%;
				background-color:#555;
			}
			#report-inappropriate-content-inner { padding:.5em; }
			#report-inappropriate-content-inner div.big {
				height:5em;
				padding-top:2em;
				text-align:center;
				font-size:250%;
			}
			#report-inappropriate-content-inner div.big2 { font-size:70%; }
			div.inappropriate-option { margin:.5em 0; }
		</style>
		<script type="text/javascript">
			var reportNodeId = null;
			Nabble.reportContent = function(nodeId) {
				reportNodeId = nodeId;
				$('#report-inappropriate-content').show();
				var url = '/template/NamlServlet.jtp?macro=report_inappropriate_content_form';
				$.get(url, function(data) {
					$('#report-inappropriate-content-inner').html(data);
				});
			}
			Nabble.closeReport = function() {
				$('#report-inappropriate-content').hide();
			}
			Nabble.sendReport = function() {
				$('#send-report-button').attr('disabled','true').addClass('toolbar-disabled');
				var type = $('input[name=report_type]:checked').val();
				var url = '/template/NamlServlet.jtp?macro=report_inappropriate_content_submit&node='+reportNodeId+'&type='+type+Nabble.getClientID();
				$.get(url, function(data) {
					var h = 'Thank You';
					h += '<div class="weak-color big2">We will review your report soon.</div>';
					h += '<a href="javascript: void Nabble.closeReport()">Close</a>';
					$('#report-inappropriate-content-inner').html('<div class="big">'+h+'</div>');
				});
			}
		</script>
					<script type="text/javascript">
		Nabble.setFontSize();
		
	</script>
	<script type="text/javascript">
		if (Nabble.analytics) Nabble.analytics();
	</script><script src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/VisitCounter.jtp" type="text/javascript"></script>
	<!-- Start Quantcast tag -->
	<script type="text/javascript">
		_qoptions={ qacct:"p-34EL1DZyJypTI" };
	</script>
	<script type="text/javascript" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/quant.js"></script>
	<noscript>
		&lt;a href="http://www.quantcast.com/p-34EL1DZyJypTI" target="_blank" rel="nofollow"&gt;
			&lt;img src="http://pixel.quantserve.com/pixel/p-34EL1DZyJypTI.gif" style="display: none;" border="0" height="1" width="1" alt="Quantcast"/&gt;
		&lt;/a&gt;
	</noscript>
	<!-- End Quantcast tag -->
	<!-- Start Google Analytics -->
	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['nabble._setAccount', 'UA-91855-9']);
		_gaq.push(['nabble._trackPageview']);
		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>
	<!-- End Google Analytics -->
	<script type="text/javascript">
		var site_admins = [1, 3196, 20, 3311];
	</script>
	<script type="text/javascript">
		var isSafe = true;
		var Ads = Ads || {};
		Ads.text = {
			daysLeft: 'Trial period ends in $1 day(s)',
			removeAds: 'Remove Ads',
			buyCredits: 'Buy credits'
		};
		$(document).ready(function() {
			if (Nabble.wasCreatedRecently && Nabble.currentCredits == 0) {
				var s = '<div class="weak-color" style="text-align:center;margin:1em;font-size:80%">';
				s += Ads.text.daysLeft.replace(/\$1/,daysLeft)+' &ndash; ';
				s += '<a href="'+Nabble.buyCreditsPath+'">'+(Nabble.isSafe?Ads.text.removeAds:Ads.text.buyCredits)+'</a>';
				s += '</div>';
				var isAdmin = Nabble.userId && site_admins.indexOf(Number(Nabble.userId)) >= 0;
				if (!isSafe || isAdmin)
					$('div.nabble').append(s);
			}
		});
	</script>
	<script type="text/javascript">
		$(document).ready(function() {
			if (Nabble.userId && site_admins.indexOf(Number(Nabble.userId)) >= 0)
				$('div.no-ads-message').show();
		});
	</script>
				</head>
				<body>
					<div id="notice" class="notice rounded-bottom"></div>
					<div class="nabble macro_classic_forum_topic" id="nabble">
						
			
			<div class="top-bar">
		<div class="breadcrumbs" style="float:left">
			<span id="breadcrumbs" class="weak-color">
		
				<a href="http://apache-spark-user-list.1001560.n3.nabble.com/">Apache Spark User List</a>
	</span>
		</div>
		<div style="text-align:right;">
			<span style="white-space:nowrap;" id="nabble-user-header"><span id="user-dd"><span id="usrdd" class="dropdown"><a href="javascript:void(0)">charles.li</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingusrdd" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanusrdd">Loading...</span></td></tr><tr id="myPosts"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=3457">My posts</a></td></tr><tr id="personalSettings"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_profile">Account settings</a></td></tr><tr id="adminNotice" style="display:none"><td style="border:none"><a href="javascript: void Nabble.showAdminNotice()">Show Nabble notice</a></td></tr><tr id="logout"><td style="border:none"><a href="javascript: void Nabble.logout()">Log out</a></td></tr></tbody></table></span></span></span>
	<script type="text/javascript">Nabble.userHeader();</script>
		</div>
	</div>
			
			<div id="nabble-newsflash" class="info-message" style="display:none;padding:.5em;margin-bottom:.5em"></div>
	
			<div id="topic-search-box" class="search-box float-right" style="padding:.5em 0">
		<form action="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp">
		<input type="hidden" name="macro" value="search_page">
		<input type="hidden" name="node" value="1">
		
		
		
		<input id="search-input" name="query" size="18" class="medium-border-color">
		<div id="search-box-dropdown" class="search-box-dropdown light-bg-color drop-shadow border1 medium-border-color rounded-bottom">
		<div style="margin:.5em .5em 0 .5em">
					<b>Search</b><br>
					<input id="search-root-node" type="radio" name="n" value="1" checked="true">
					<label for="search-root-node">everywhere</label><br>

					<input id="search-this-node" type="radio" name="n" value="8937">
					<label for="search-this-node">
						only in this topic
					</label>
				</div>
		<div style="margin:.5em;line-height:2em">
			<input class="toolbar action-button float-right" type="submit" value="Search">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=adv_search_page&node=8937" rel="nofollow" style="font-size:80%">Advanced Search</a>
		</div>
	</div>
	</form>
	</div>

	<h1 id="post-title" class="adbayes-content" style="margin:0.25em 0 .8em">
		Which is the best way to get a connection to an external database per task in Spark Streaming?
	</h1>
			<div style="margin:1.2em 0 5em">
		<div id="topics-controls-left" class="float-left nowrap">
			<table>
		<tbody><tr>
			<td style="padding-right:.1em">
		<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/view-classic.gif" width="18" height="18" style="border:none" alt="classic">
	</td>

	<td style="padding-right:1.1em">
		Classic
	</td>

			<td style="padding-right:.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView(&#39;list&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tc8937.html&#39;,null)"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/view-list.gif" width="18" height="18" style="border:none" alt="list"></a>
	</td>

	<td style="padding-right:1.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView(&#39;list&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tc8937.html&#39;,null)">List</a>
	</td>

			<td style="padding-right:.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html&#39;,null)"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/view-threaded.gif" width="18" height="18" style="border:none" alt="threaded"></a>
	</td>

	<td style="padding-right:1.1em">
		<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html&#39;,null)">Threaded</a>
	</td>
		</tr>
	</tbody></table>
		</div>
		<div id="topics-controls-right" class="float-right nowrap" style="padding-top:.3em"><span id="turn-off-highlight-control"><span class="highlight">&nbsp;X&nbsp;</span> <a href="javascript:void(0)" onclick="Nabble.turnOffHighlight()">Turn off highlighting</a></span>
			<span style="padding-right:1em;height:21px">
		<img id="pin-icon" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/pin.png" width="20" height="21" title="This topic has been pinned in Apache Spark User List." style="vertical-align:middle;display:none;">
		<div id="tooltip8813" class="nabble-tooltip" use_title="true">
		
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip8813'), 'up', 400);
	</script>
	</span>
	<span id="lock-icon" class="weak-color" style="padding:0 .5em;margin-right:.5em;display:none;">
		<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/lock_sm.png" width="10" height="15" style="vertical-align:middle"> Locked
	</span>
	<span style="padding-right:1em">
		7 messages
	</span>
	<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/gear.png" class="image16" alt="Options">
	<span id="dd_topicdropdown"><span id="topicdropdown" class="dropdown"><a href="javascript:void(0)" title="Click for more options">Options</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingtopicdropdown" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpantopicdropdown">Loading...</span></td></tr><tr id="topicSubscriptionLink"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=subscribe&node=8937" rel="nofollow">Subscribe via email</a></td></tr><tr class="dropdown-separator"><td class="action-separator medium-border-color">&nbsp;</td></tr><tr id="moveTopic" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=8937" rel="nofollow">Move topic</a></td></tr><tr id="pinTopic" style="display:none"><td style="border:none"><a href="javascript: void Nabble.pinTopic(8937)" rel="nofollow">Pin topic</a></td></tr><tr id="unpinTopic" style="display:none"><td style="border:none"><a href="javascript: void Nabble.unpinTopic(8937)" rel="nofollow">Unpin topic</a></td></tr><tr id="lockTopic" style="display:none"><td style="border:none"><a href="javascript: void Nabble.lockTopic(8937)" rel="nofollow">Lock topic</a></td></tr><tr id="unlockTopic" style="display:none"><td style="border:none"><a href="javascript: void Nabble.unlockTopic(8937)" rel="nofollow">Unlock topic</a></td></tr><tr id="deleteRecursively" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(8937)" rel="nofollow">Delete this topic</a></td></tr><tr id="deletePost" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(8937)" rel="nofollow">Delete this topic</a></td></tr><tr id="changeMetaTags" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_title_and_meta_tags&node=8937" rel="nofollow">Change title and meta tags</a></td></tr><tr id="embedPost8937"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/embed/EmbedOptions.jtp?node=8937" rel="nofollow">Embed post</a></td></tr><tr id="permalink8937"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937.html&#39;)">Permalink</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("topicdropdown", "Options","Click for more options");
		
		dropdown.add('topicSubscriptionLink', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dsubscribe&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3ESubscribe via email\x3C/a\x3E');
		dropdown.addSeparator();
		dropdown.add('moveTopic', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3EMove topic\x3C/a\x3E', 'display:none');
		dropdown.add('pinTopic', '\x3Ca href\x3D\"javascript: void Nabble.pinTopic(8937)\" rel\x3D\"nofollow\"\x3EPin topic\x3C/a\x3E', 'display:none');
		dropdown.add('unpinTopic', '\x3Ca href\x3D\"javascript: void Nabble.unpinTopic(8937)\" rel\x3D\"nofollow\"\x3EUnpin topic\x3C/a\x3E', 'display:none');
		dropdown.add('lockTopic', '\x3Ca href\x3D\"javascript: void Nabble.lockTopic(8937)\" rel\x3D\"nofollow\"\x3ELock topic\x3C/a\x3E', 'display:none');
		dropdown.add('unlockTopic', '\x3Ca href\x3D\"javascript: void Nabble.unlockTopic(8937)\" rel\x3D\"nofollow\"\x3EUnlock topic\x3C/a\x3E', 'display:none');
		dropdown.add('deleteRecursively', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(8937)\" rel\x3D\"nofollow\"\x3EDelete this topic\x3C/a\x3E', 'display:none');
			dropdown.add('deletePost', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(8937)\" rel\x3D\"nofollow\"\x3EDelete this topic\x3C/a\x3E', 'display:none');
		dropdown.add('changeMetaTags', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_title_and_meta_tags&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3EChange title and meta tags\x3C/a\x3E', 'display:none');
		dropdown.add('embedPost8937', '\x3Ca href\x3D\"/embed/EmbedOptions.jtp?node\x3D8937\" rel\x3D\"nofollow\"\x3EEmbed post\x3C/a\x3E');
		dropdown.add('permalink8937', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.build('dd_topicdropdown');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=topic_dropdown_later&node=8937' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
		</div>
	</div>
			<div id="topic-contents" style="margin-top:1em;clear:both">
		<div id="classic-contents">
		
		<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461">Juan Rodríguez Hortalá</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=8937" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html&#39;,8937)">Threaded</a>
	<div id="tooltip51935" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip51935'), 'up', 400);
	</script> |
					<span id="dd_postdropdown8937"><span id="postdropdown8937" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown8937" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown8937">Loading...</span></td></tr><tr id="replyToAuthor8937" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=8937" rel="nofollow">Reply to author</a></td></tr><tr id="editPost8937" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=8937" rel="nofollow">Edit post</a></td></tr><tr id="movePost8937" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=8937" rel="nofollow">Move post</a></td></tr><tr id="deletePost8937" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(8937)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively8937" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(8937)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate8937" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=8937" rel="nofollow">Change post date</a></td></tr><tr id="print8937"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=8937" rel="nofollow">Print post</a></td></tr><tr id="permalink8937"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937.html&#39;)">Permalink</a></td></tr><tr id="rawMail8937" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=8937" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown8937", "More","Click for more options");
		
		dropdown.add('replyToAuthor8937', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D8937\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost8937', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost8937', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost8937', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(8937)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively8937', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(8937)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate8937', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print8937', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink8937', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail8937', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D8937\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown8937');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=8937' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(8937)">
	<div id="tooltip90084" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip90084'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow8937" class="float-left invisible" style="margin-top: 0.2em; display: inline;">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404758449000-684">Jul 08, 2014; 2:40am</span><script type="text/javascript">
		Nabble.get('d1404758449000-684').innerHTML= Nabble.formatDateLong(new Date(1404758449000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461" rel="nofollow" title="View profile of Juan Rodríguez Hortalá" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/c604bb117ab89bb656c33c7a95cbf384" height="100" width="100" alt="Juan Rodríguez Hortalá" title="Juan Rodríguez Hortalá"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online1461 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count1461 avatar-label weak-color">13 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message8937" class="message-text adbayes-content"><span>
		</span><div dir="ltr"><div><div><div><span>Hi list,</span><br><br><span>I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel. </span><br><span>
- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to </span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_top" rel="nofollow" link="external"><span>http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>
- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>
- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality of the connection to the database.</span><br><span>
- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_top" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>
- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object. </span><br><span>
</span><br><span>So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_top" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_top" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><br><span>
</span><br></div><span>Thanks in advance,</span><br><br></div><span>Greetings,</span><br><br></div><span>Juan</span><br><div><div><div><div><div><br></div></div></div></div></div></div><span>


	
	
	
	</span></div>
	<script type="text/javascript">
				Nabble.ads('first_classic_message');
			</script><div class="ad " style="display:block !important;visibility:visible !important;height:auto !important; width: auto !important;position:static !important;top:auto !important;left:auto !important;text-align:left;width:675px !important;">
<div style="width:336px; float:left; clear:none; display:block !important;" class="div183119">
<script type="text/javascript">Nabble._fn()</script><a id="ad183119" href="http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-td8937.html#" style="display:none">.</a>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><style type="text/css">.nabble .div183119 ins { display:inline-table !important; visibility: visible !important; height:280px !important; width: 336px !important; position:static !important;top:auto !important;left:auto !important; }.nabble .div183119 ins ins iframe { display:block !important; visibility: visible !important; height:280px !important; width: 336px !important; position:static !important;top:auto !important;left:auto !important; }</style>
</div>
<div style="width:336px; float:left; clear:none; display:block !important;" class="div437384">
<script type="text/javascript">Nabble._fn()</script><a id="ad437384" href="http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-td8937.html#" style="display:none">.</a>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><style type="text/css">.nabble .div437384 ins { display:inline-table !important; visibility: visible !important; height:280px !important; width: 336px !important; position:static !important;top:auto !important;left:auto !important; }.nabble .div437384 ins ins iframe { display:block !important; visibility: visible !important; height:280px !important; width: 336px !important; position:static !important;top:auto !important;left:auto !important; }</style>
</div>
<div style="padding-top:.3em;font-size:90%;clear:both"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=buy_credits_page">Remove Ads</a></div>
</div>

			
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=943">Tobias Pfeiffer</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=8977" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html#a8977&#39;,8977)">Threaded</a>
	<div id="tooltip52995" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip52995'), 'up', 400);
	</script> |
					<span id="dd_postdropdown8977"><span id="postdropdown8977" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown8977" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown8977">Loading...</span></td></tr><tr id="replyToAuthor8977" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=8977" rel="nofollow">Reply to author</a></td></tr><tr id="editPost8977" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=8977" rel="nofollow">Edit post</a></td></tr><tr id="movePost8977" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=8977" rel="nofollow">Move post</a></td></tr><tr id="deletePost8977" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(8977)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively8977" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(8977)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate8977" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=8977" rel="nofollow">Change post date</a></td></tr><tr id="print8977"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=8977" rel="nofollow">Print post</a></td></tr><tr id="permalink8977"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p8977.html&#39;)">Permalink</a></td></tr><tr id="rawMail8977" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=8977" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown8977", "More","Click for more options");
		
		dropdown.add('replyToAuthor8977', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D8977\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost8977', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D8977\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost8977', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D8977\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost8977', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(8977)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively8977', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(8977)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate8977', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D8977\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print8977', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D8977\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink8977', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p8977.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail8977', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D8977\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown8977');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=8977' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(8977)">
	<div id="tooltip1946" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip1946'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow8977" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404783021000-80">Jul 08, 2014; 9:30am</span><script type="text/javascript">
		Nabble.get('d1404783021000-80').innerHTML= Nabble.formatDateLong(new Date(1404783021000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		Re: Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=943" rel="nofollow" title="View profile of Tobias Pfeiffer" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/2a67d547b64cf3e6d69e152976657998" height="100" width="100" alt="Tobias Pfeiffer" title="Tobias Pfeiffer"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online943 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count943 avatar-label weak-color">159 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message8977" class="message-text adbayes-content"><span>
		</span><div dir="ltr"><span>Juan,</span><div><br></div><div><span>I am doing something similar, just not "insert into SQL database", but "issue some RPC call". I think mapPartitions() may be helpful to you. You could do something like</span></div><span>
</span><div><br></div><div><span>dstream.mapPartitions(iter =&gt; {</span></div><div><span>&nbsp; val db = new DbConnection()</span></div><div><span>&nbsp; // maybe only do the above if !iter.isEmpty</span></div><div><span>&nbsp; iter.map(item =&gt; {</span></div><div><span>&nbsp; &nbsp; db.call(...)</span></div><div><span>
&nbsp; &nbsp; // do some cleanup if !iter.hasNext here</span></div><div><span>&nbsp; &nbsp; item</span></div><div><span>&nbsp; })</span></div><div><span>}).count() // force output</span></div><div><br></div><div><span>Keep in mind though that the whole idea about <span class="bold highlight search-highlight">RDDs</span> is that operations are idempotent and in theory could be run on multiple hosts (to take the result from the fastest server) or multiple times (to deal with failures/timeouts) etc., which is maybe something you want to deal with in your SQL.</span></div><span>
</span><div><br></div><div><span>Tobias</span></div><div><br></div></div><div class="gmail_extra"><br><br><div class="gmail_quote"><span>On Tue, Jul 8, 2014 at 3:40 AM, Juan Rodríguez Hortalá </span><span dir="ltr"><span>&lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=8977&i=0" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;</span></span><span> wrote:</span><br><span>
</span><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><div><div><div><span>Hi list,</span><br><br><span>I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel. </span><br><span>

- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to </span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_blank" rel="nofollow" link="external"><span>http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>

- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>

- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality of the connection to the database.</span><br><span>

- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_blank" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>

- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object. </span><br><span>

</span><br><span>So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_blank" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_blank" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><br><span>

</span><br></div><span>Thanks in advance,</span><br><br></div><span>Greetings,</span><br><br></div><span>Juan</span><br><div><div><div><div><div><br></div></div></div></div></div></div><span>
</span></blockquote></div><br></div><span>


	
	
	
	</span></div>
	
			
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461">Juan Rodríguez Hortalá</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=9009" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html#a9009&#39;,9009)">Threaded</a>
	<div id="tooltip65174" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip65174'), 'up', 400);
	</script> |
					<span id="dd_postdropdown9009"><span id="postdropdown9009" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown9009" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown9009">Loading...</span></td></tr><tr id="replyToAuthor9009" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=9009" rel="nofollow">Reply to author</a></td></tr><tr id="editPost9009" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=9009" rel="nofollow">Edit post</a></td></tr><tr id="movePost9009" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=9009" rel="nofollow">Move post</a></td></tr><tr id="deletePost9009" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(9009)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively9009" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(9009)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate9009" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=9009" rel="nofollow">Change post date</a></td></tr><tr id="print9009"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=9009" rel="nofollow">Print post</a></td></tr><tr id="permalink9009"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9009.html&#39;)">Permalink</a></td></tr><tr id="rawMail9009" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=9009" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown9009", "More","Click for more options");
		
		dropdown.add('replyToAuthor9009', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D9009\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost9009', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D9009\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost9009', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D9009\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost9009', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(9009)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively9009', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(9009)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate9009', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D9009\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print9009', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D9009\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink9009', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9009.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail9009', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D9009\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown9009');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=9009' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(9009)">
	<div id="tooltip31314" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip31314'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow9009" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404811143000-918">Jul 08, 2014; 5:19pm</span><script type="text/javascript">
		Nabble.get('d1404811143000-918').innerHTML= Nabble.formatDateLong(new Date(1404811143000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		Re: Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461" rel="nofollow" title="View profile of Juan Rodríguez Hortalá" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/c604bb117ab89bb656c33c7a95cbf384" height="100" width="100" alt="Juan Rodríguez Hortalá" title="Juan Rodríguez Hortalá"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online1461 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count1461 avatar-label weak-color">13 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message9009" class="message-text adbayes-content"><span>
		</span><div dir="ltr"><div><span>Hi Tobias, thanks for your help. I understand that with that code we obtain a database connection per partition, but I also suspect that with that code a new database connection is created per each execution of the function used as argument for mapPartitions(). That would be very inefficient because a new object and a new database connection would be created for each batch of the DStream. But my knowledge about the lifecycle of Functions in Spark Streaming is very limited, so maybe I'm wrong, what do you think? </span><br><span>
</span><br><br></div><div><span>Greetings,</span><br><br></div><div><span>Juan</span><br></div></div><div class="gmail_extra"><br><br><div class="gmail_quote"><span>2014-07-08 3:30 GMT+02:00 Tobias Pfeiffer </span><span dir="ltr"><span>&lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9009&i=0" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;</span></span><span>:</span><br><span>
</span><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><span>Juan,</span><div><br></div><div><span>I am doing something similar, just not "insert into SQL database", but "issue some RPC call". I think mapPartitions() may be helpful to you. You could do something like</span></div><span>

</span><div><br></div><div><span>dstream.mapPartitions(iter =&gt; {</span></div><div><span>&nbsp; val db = new DbConnection()</span></div><div><span>&nbsp; // maybe only do the above if !iter.isEmpty</span></div><div><span>&nbsp; iter.map(item =&gt; {</span></div><div><span>&nbsp; &nbsp; db.call(...)</span></div><div><span>

&nbsp; &nbsp; // do some cleanup if !iter.hasNext here</span></div><div><span>&nbsp; &nbsp; item</span></div><div><span>&nbsp; })</span></div><div><span>}).count() // force output</span></div><div><br></div><div><span>Keep in mind though that the whole idea about <span class="bold highlight search-highlight">RDDs</span> is that operations are idempotent and in theory could be run on multiple hosts (to take the result from the fastest server) or multiple times (to deal with failures/timeouts) etc., which is maybe something you want to deal with in your SQL.</span></div><span>
</span><span class="HOEnZb"><font color="#888888"><span>
</span><div><br></div><div><span>Tobias</span></div><div><br></div></font></span></div><div class="HOEnZb"><div class="h5"><div class="gmail_extra"><br><br><div class="gmail_quote"><span>On Tue, Jul 8, 2014 at 3:40 AM, Juan Rodríguez Hortalá </span><span dir="ltr"><span>&lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9009&i=1" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;</span></span><span> wrote:</span><br><span>

</span><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><div dir="ltr"><div><div><div><span>Hi list,</span><br><br><span>I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel. </span><br><span>


- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to </span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_blank" rel="nofollow" link="external"><span>http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>


- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>


- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality of the connection to the database.</span><br><span>


- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_blank" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>


- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object. </span><br><span>


</span><br><span>So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_blank" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_blank" rel="nofollow" link="external"><span>http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><br><span>


</span><br></div><span>Thanks in advance,</span><br><br></div><span>Greetings,</span><br><br></div><span>Juan</span><br><div><div><div><div><div><br></div></div></div></div></div></div><span>
</span></blockquote></div><br></div><span>
</span></div></div></blockquote></div><br></div><span>


	
	
	
	</span></div>
	
			
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=5">Shao, Saisai</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=9012" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html#a9012&#39;,9012)">Threaded</a>
	<div id="tooltip28151" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip28151'), 'up', 400);
	</script> |
					<span id="dd_postdropdown9012"><span id="postdropdown9012" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown9012" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown9012">Loading...</span></td></tr><tr id="replyToAuthor9012" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=9012" rel="nofollow">Reply to author</a></td></tr><tr id="editPost9012" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=9012" rel="nofollow">Edit post</a></td></tr><tr id="movePost9012" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=9012" rel="nofollow">Move post</a></td></tr><tr id="deletePost9012" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(9012)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively9012" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(9012)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate9012" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=9012" rel="nofollow">Change post date</a></td></tr><tr id="print9012"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=9012" rel="nofollow">Print post</a></td></tr><tr id="permalink9012"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9012.html&#39;)">Permalink</a></td></tr><tr id="rawMail9012" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=9012" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown9012", "More","Click for more options");
		
		dropdown.add('replyToAuthor9012', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D9012\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost9012', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D9012\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost9012', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D9012\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost9012', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(9012)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively9012', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(9012)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate9012', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D9012\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print9012', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D9012\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink9012', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9012.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail9012', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D9012\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown9012');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=9012' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(9012)">
	<div id="tooltip18319" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip18319'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow9012" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404812696000-556">Jul 08, 2014; 5:44pm</span><script type="text/javascript">
		Nabble.get('d1404812696000-556').innerHTML= Nabble.formatDateLong(new Date(1404812696000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		RE: Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=5" rel="nofollow" title="View profile of Shao, Saisai" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/24fb58dab7ef7c3202c4c8061ee51a12" height="100" width="100" alt="Shao, Saisai" title="Shao, Saisai"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online5 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count5 avatar-label weak-color">70 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message9012" class="message-text adbayes-content"><span>
		

</span><span>
</span><meta name="Generator" content="Microsoft Word 14 (filtered medium)"><span>
</span><!--[if gte mso 9]><xml>
<o:shapedefaults v:ext="edit" spidmax="1026" />
</xml><![endif]--><!--[if gte mso 9]><xml>
<o:shapelayout v:ext="edit">
<o:idmap v:ext="edit" data="1" />
</o:shapelayout></xml><![endif]--><span>


</span><div class="WordSection1"><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>I think you can maintain a connection pool or keep the connection as a long-lived object in executor side (like lazily creating a singleton object
 in object { } in Scala), so your task can get this connection each time executing a task, not creating a new one, that would be good for your scenario, since create a connection is quite expensive for each task.</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Thanks</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Jerry</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><p class="MsoNormal"><b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"><span>From:</span></span></b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"><span> Juan Rodríguez Hortalá [mailto:</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9012&i=0" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>]
</span><br><span>
</span><b><span>Sent:</span></b><span> Tuesday, July 08, 2014 5:19 PM</span><br><span>
</span><b><span>To:</span></b><span> Tobias Pfeiffer</span><br><span>
</span><b><span>Cc:</span></b><span> </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9012&i=1" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><br><span>
</span><b><span>Subject:</span></b><span> Re: Which is the best way to get a connection to an external database per task in Spark Streaming?</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi Tobias, thanks for your help. I understand that with that code we obtain a database connection per partition, but I also suspect that with that code a new database connection is created
 per each execution of the function used as argument for mapPartitions(). That would be very inefficient because a new object and a new database connection would be created for each batch of the DStream. But my knowledge about the lifecycle of Functions in
 Spark Streaming is very limited, so maybe I'm wrong, what do you think? </span><br><span>
</span><br><span>
</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><o:p></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>2014-07-08 3:30 GMT+02:00 Tobias Pfeiffer &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9012&i=2" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;:</span><o:p></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan,</span><o:p></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>I am doing something similar, just not "insert into SQL database", but "issue some RPC call". I think mapPartitions() may be helpful to you. You could do something like</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>dstream.mapPartitions(iter =&gt; {</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; val db = new DbConnection()</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; // maybe only do the above if !iter.isEmpty</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; iter.map(item =&gt; {</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; db.call(...)</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; // do some cleanup if !iter.hasNext here</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; item</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; })</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>}).count() // force output</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Keep in mind though that the whole idea about <span class="bold highlight search-highlight">RDDs</span> is that operations are idempotent and in theory could be run on multiple hosts (to take the result from the fastest server) or multiple times (to deal with failures/timeouts)
 etc., which is maybe something you want to deal with in your SQL.</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US" style="color:#888888"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US" style="color:#888888"><span>Tobias</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US" style="color:#888888"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>On Tue, Jul 8, 2014 at 3:40 AM, Juan Rodríguez Hortalá &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9012&i=3" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt; wrote:</span><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi list,</span><br><span>
</span><br><span>
I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each
 worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel.
</span><br><span>
- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to
</span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_blank" rel="nofollow" link="external"><span>
http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>
- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>
- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality
 of the connection to the database.</span><br><span>
- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark
 worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>
- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object.
</span><br><span>
</span><br><span>
So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Thanks in advance,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span></div><span>




	
	
	
	</span></div>
	
			
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461">Juan Rodríguez Hortalá</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=9017" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html#a9017&#39;,9017)">Threaded</a>
	<div id="tooltip91871" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip91871'), 'up', 400);
	</script> |
					<span id="dd_postdropdown9017"><span id="postdropdown9017" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown9017" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown9017">Loading...</span></td></tr><tr id="replyToAuthor9017" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=9017" rel="nofollow">Reply to author</a></td></tr><tr id="editPost9017" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=9017" rel="nofollow">Edit post</a></td></tr><tr id="movePost9017" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=9017" rel="nofollow">Move post</a></td></tr><tr id="deletePost9017" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(9017)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively9017" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(9017)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate9017" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=9017" rel="nofollow">Change post date</a></td></tr><tr id="print9017"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=9017" rel="nofollow">Print post</a></td></tr><tr id="permalink9017"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9017.html&#39;)">Permalink</a></td></tr><tr id="rawMail9017" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=9017" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown9017", "More","Click for more options");
		
		dropdown.add('replyToAuthor9017', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D9017\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost9017', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D9017\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost9017', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D9017\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost9017', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(9017)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively9017', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(9017)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate9017', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D9017\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print9017', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D9017\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink9017', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9017.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail9017', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D9017\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown9017');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=9017' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(9017)">
	<div id="tooltip71022" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip71022'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow9017" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404816864000-340">Jul 08, 2014; 6:54pm</span><script type="text/javascript">
		Nabble.get('d1404816864000-340').innerHTML= Nabble.formatDateLong(new Date(1404816864000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		Re: Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461" rel="nofollow" title="View profile of Juan Rodríguez Hortalá" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/c604bb117ab89bb656c33c7a95cbf384" height="100" width="100" alt="Juan Rodríguez Hortalá" title="Juan Rodríguez Hortalá"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online1461 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count1461 avatar-label weak-color">13 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message9017" class="message-text adbayes-content"><span>
		</span><div dir="ltr"><div><div><div><span>Hi Jerry, thanks for your answer. I'm using Spark Streaming for Java, and I only have rudimentary knowledge about Scala, how could I recreate in Java the lazy creation of a singleton object that you propose for Scala? Maybe a static class member in Java for the connection would be the solution? </span><br><span>
</span><br></div><span>Thanks again for your help, </span><br><br></div><span>Best Regards,</span><br><br></div><span>Juan</span><br></div><div class="gmail_extra"><br><br><div class="gmail_quote"><span>2014-07-08 11:44 GMT+02:00 Shao, Saisai </span><span dir="ltr"><span>&lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9017&i=0" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;</span></span><span>:</span><br><span>
</span><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><span>





</span><div link="blue" vlink="purple" lang="ZH-CN"><span>
</span><div><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>I think you can maintain a connection pool or keep the connection as a long-lived object in executor side (like lazily creating a singleton object
 in object { } in Scala), so your task can get this connection each time executing a task, not creating a new one, that would be good for your scenario, since create a connection is quite expensive for each task.</span><u></u><u></u></span></p><span>

</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Thanks</span><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Jerry</span><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><p class="MsoNormal"><b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;" lang="EN-US"><span>From:</span></span></b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;" lang="EN-US"><span> Juan Rodríguez Hortalá [mailto:</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9017&i=1" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>]
</span><br><span>
</span><b><span>Sent:</span></b><span> Tuesday, July 08, 2014 5:19 PM</span><br><span>
</span><b><span>To:</span></b><span> Tobias Pfeiffer</span><br><span>
</span><b><span>Cc:</span></b><span> </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9017&i=2" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><br><span>
</span><b><span>Subject:</span></b><span> Re: Which is the best way to get a connection to an external database per task in Spark Streaming?</span><u></u><u></u></span></p><div><div class="h5"><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi Tobias, thanks for your help. I understand that with that code we obtain a database connection per partition, but I also suspect that with that code a new database connection is created
 per each execution of the function used as argument for mapPartitions(). That would be very inefficient because a new object and a new database connection would be created for each batch of the DStream. But my knowledge about the lifecycle of Functions in
 Spark Streaming is very limited, so maybe I'm wrong, what do you think? </span><br><span>
</span><br><span>
</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><u></u><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>2014-07-08 3:30 GMT+02:00 Tobias Pfeiffer &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9017&i=3" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;:</span><u></u><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan,</span><u></u><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>I am doing something similar, just not "insert into SQL database", but "issue some RPC call". I think mapPartitions() may be helpful to you. You could do something like</span><u></u><u></u></span></p><span>

</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>dstream.mapPartitions(iter =&gt; {</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; val db = new DbConnection()</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; // maybe only do the above if !iter.isEmpty</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; iter.map(item =&gt; {</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; db.call(...)</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; // do some cleanup if !iter.hasNext here</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; item</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; })</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>}).count() // force output</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Keep in mind though that the whole idea about <span class="bold highlight search-highlight">RDDs</span> is that operations are idempotent and in theory could be run on multiple hosts (to take the result from the fastest server) or multiple times (to deal with failures/timeouts)
 etc., which is maybe something you want to deal with in your SQL.</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="color:#888888" lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="color:#888888" lang="EN-US"><span>Tobias</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="color:#888888" lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>On Tue, Jul 8, 2014 at 3:40 AM, Juan Rodríguez Hortalá &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9017&i=4" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt; wrote:</span><u></u><u></u></span></p><span>

</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi list,</span><br><span>
</span><br><span>
I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each
 worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel.
</span><br><span>
- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to
</span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_blank" rel="nofollow" link="external"><span>
http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>
- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>

- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality
 of the connection to the database.</span><br><span>
- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark
 worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>
- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object.
</span><br><span>
</span><br><span>
So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Thanks in advance,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><u></u><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span></div></div></div><span>
</span></div><span>

</span></blockquote></div><br></div><span>


	
	
	
	</span></div>
	
			
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=5">Shao, Saisai</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=9117" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html#a9117&#39;,9117)">Threaded</a>
	<div id="tooltip59728" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip59728'), 'up', 400);
	</script> |
					<span id="dd_postdropdown9117"><span id="postdropdown9117" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown9117" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown9117">Loading...</span></td></tr><tr id="replyToAuthor9117" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=9117" rel="nofollow">Reply to author</a></td></tr><tr id="editPost9117" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=9117" rel="nofollow">Edit post</a></td></tr><tr id="movePost9117" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=9117" rel="nofollow">Move post</a></td></tr><tr id="deletePost9117" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(9117)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively9117" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(9117)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate9117" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=9117" rel="nofollow">Change post date</a></td></tr><tr id="print9117"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=9117" rel="nofollow">Print post</a></td></tr><tr id="permalink9117"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9117.html&#39;)">Permalink</a></td></tr><tr id="rawMail9117" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=9117" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown9117", "More","Click for more options");
		
		dropdown.add('replyToAuthor9117', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D9117\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost9117', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D9117\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost9117', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D9117\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost9117', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(9117)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively9117', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(9117)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate9117', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D9117\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print9117', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D9117\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink9117', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9117.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail9117', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D9117\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown9117');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=9117' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(9117)">
	<div id="tooltip78628" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip78628'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow9117" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404868125000-309">Jul 09, 2014; 9:08am</span><script type="text/javascript">
		Nabble.get('d1404868125000-309').innerHTML= Nabble.formatDateLong(new Date(1404868125000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		RE: Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=5" rel="nofollow" title="View profile of Shao, Saisai" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/24fb58dab7ef7c3202c4c8061ee51a12" height="100" width="100" alt="Shao, Saisai" title="Shao, Saisai"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online5 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count5 avatar-label weak-color">70 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message9117" class="message-text adbayes-content"><span>
		

</span><span>
</span><meta name="Generator" content="Microsoft Word 14 (filtered medium)"><span>
</span><!--[if gte mso 9]><xml>
<o:shapedefaults v:ext="edit" spidmax="1026" />
</xml><![endif]--><!--[if gte mso 9]><xml>
<o:shapelayout v:ext="edit">
<o:idmap v:ext="edit" data="1" />
</o:shapelayout></xml><![endif]--><span>


</span><div class="WordSection1"><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Yes, that would be the Java equivalence to use static class member, but you should carefully program to prevent resource leakage. A good choice
 is to use third-party DB connection library which supports connection pool, that will alleviate your programming efforts.</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Thanks</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Jerry</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><p class="MsoNormal"><b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"><span>From:</span></span></b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"><span> Juan Rodríguez Hortalá [mailto:</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=0" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>]
</span><br><span>
</span><b><span>Sent:</span></b><span> Tuesday, July 08, 2014 6:54 PM</span><br><span>
</span><b><span>To:</span></b><span> </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=1" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><br><span>
</span><b><span>Subject:</span></b><span> Re: Which is the best way to get a connection to an external database per task in Spark Streaming?</span><o:p></o:p></span></p><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi Jerry, thanks for your answer. I'm using Spark Streaming for Java, and I only have rudimentary knowledge about Scala, how could I recreate in Java the lazy creation of a singleton object
 that you propose for Scala? Maybe a static class member in Java for the connection would be the solution?
</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Thanks again for your help,
</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Best Regards,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>2014-07-08 11:44 GMT+02:00 Shao, Saisai &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=2" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;:</span><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>I think you can maintain a connection pool or keep the connection as a long-lived object
 in executor side (like lazily creating a singleton object in object { } in Scala), so your task can get this connection each time executing a task, not creating a new one, that would be good for your scenario, since create a connection is quite expensive for
 each task.</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>&nbsp;</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Thanks</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>Jerry</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1F497D"><span>&nbsp;</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"><span>From:</span></span></b><span lang="EN-US" style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;"><span> Juan
 Rodríguez Hortalá [mailto:</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=3" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>]
</span><br><span>
</span><b><span>Sent:</span></b><span> Tuesday, July 08, 2014 5:19 PM</span><br><span>
</span><b><span>To:</span></b><span> Tobias Pfeiffer</span><br><span>
</span><b><span>Cc:</span></b><span> </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=4" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><br><span>
</span><b><span>Subject:</span></b><span> Re: Which is the best way to get a connection to an external database per task in Spark Streaming?</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>Hi Tobias, thanks for your help. I understand that with that code we obtain a database connection per partition, but I also suspect that with that code a new database
 connection is created per each execution of the function used as argument for mapPartitions(). That would be very inefficient because a new object and a new database connection would be created for each batch of the DStream. But my knowledge about the lifecycle
 of Functions in Spark Streaming is very limited, so maybe I'm wrong, what do you think?
</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>Juan</span><o:p></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>2014-07-08 3:30 GMT+02:00 Tobias Pfeiffer &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=5" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;:</span><o:p></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>Juan,</span><o:p></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>I am doing something similar, just not "insert into SQL database", but "issue some RPC call". I think mapPartitions() may be helpful to you. You could do something
 like</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>dstream.mapPartitions(iter =&gt; {</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; val db = new DbConnection()</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; // maybe only do the above if !iter.isEmpty</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; iter.map(item =&gt; {</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; &nbsp; db.call(...)</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; &nbsp; // do some cleanup if !iter.hasNext here</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; &nbsp; item</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp; })</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>}).count() // force output</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>Keep in mind though that the whole idea about <span class="bold highlight search-highlight">RDDs</span> is that operations are idempotent and in theory could be run on multiple hosts (to take the result from the
 fastest server) or multiple times (to deal with failures/timeouts) etc., which is maybe something you want to deal with in your SQL.</span><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="color:#888888"><span>&nbsp;</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="color:#888888"><span>Tobias</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US" style="color:#888888"><span>&nbsp;</span></span><span lang="EN-US"><o:p></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>On Tue, Jul 8, 2014 at 3:40 AM, Juan Rodríguez Hortalá &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9117&i=6" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;
 wrote:</span><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>Hi list,</span><br><span>
</span><br><span>
I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each
 worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel.
</span><br><span>
- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to
</span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_blank" rel="nofollow" link="external"><span>
http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>
- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>
- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality
 of the connection to the database.</span><br><span>
- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark
 worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>
- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object.
</span><br><span>
</span><br><span>
So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>Thanks in advance,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><o:p></o:p></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>Juan</span><o:p></o:p></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal" style="mso-margin-top-alt:auto;mso-margin-bottom-alt:auto"><span lang="EN-US"><span>&nbsp;</span><o:p></o:p></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><o:p><span>&nbsp;</span></o:p></span></p><span>
</span></div><span>
</span></div><span>




	
	
	
	</span></div>
	
			
				</td>
			</tr>
		</tbody></table>
	</div>
	<div class="classic-row">
		<div class="classic-header">
			<div class="classic-bar shaded-bg-color rounded-top">
				<div class="classic-author-name nowrap">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461">Juan Rodríguez Hortalá</a>
				</div>
				<div class="classic-right-menu shaded-bg-color weak-color">
					<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=reply&node=9156" rel="nofollow">Reply</a> |
					<a href="javascript:void(0)" onclick="Nabble.setView(&#39;threaded&#39;, &#39;/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tt8937.html#a9156&#39;,9156)">Threaded</a>
	<div id="tooltip77268" class="nabble-tooltip" use_title="false">
		Open this post in threaded view
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip77268'), 'up', 400);
	</script> |
					<span id="dd_postdropdown9156"><span id="postdropdown9156" class="dropdown"><a href="javascript:void(0)" title="Click for more options">More</a> <img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/more.png" width="10" height="10"><table class="light-bg-color medium-border-color drop-shadow" style="margin-top:1px;"><tbody><tr id="_loadingpostdropdown9156" style="display:none"><td class="dropdown-simple-row"><span id="_loadingSpanpostdropdown9156">Loading...</span></td></tr><tr id="replyToAuthor9156" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=pm&post=9156" rel="nofollow">Reply to author</a></td></tr><tr id="editPost9156" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=edit_post&node=9156" rel="nofollow">Edit post</a></td></tr><tr id="movePost9156" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=move_node&node=9156" rel="nofollow">Move post</a></td></tr><tr id="deletePost9156" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deletePost(9156)" rel="nofollow">Delete this post</a></td></tr><tr id="deleteRecursively9156" style="display:none"><td style="border:none"><a href="javascript: void(0)" onclick="Nabble.deleteFromSite(9156)" rel="nofollow">Delete this post and replies</a></td></tr><tr id="changePostDate9156" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=change_post_date&node=9156" rel="nofollow">Change post date</a></td></tr><tr id="print9156"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=print_post&node=9156" rel="nofollow">Print post</a></td></tr><tr id="permalink9156"><td style="border:none"><a href="javascript: void(0)" onclick="prompt(&#39;Copy this:&#39;,&#39;http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9156.html&#39;)">Permalink</a></td></tr><tr id="rawMail9156" style="display:none"><td style="border:none"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=raw_mail&node=9156" rel="nofollow">Raw mail</a></td></tr></tbody></table></span></span>
	<script type="text/javascript">
		var dropdown = new NabbleDropdown("postdropdown9156", "More","Click for more options");
		
		dropdown.add('replyToAuthor9156', '\x3Ca href\x3D\"/user/SendEmail.jtp?type\x3Dpm&amp;post\x3D9156\" rel\x3D\"nofollow\"\x3EReply to author\x3C/a\x3E', 'display:none');
		dropdown.add('editPost9156', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dedit_post&amp;node\x3D9156\" rel\x3D\"nofollow\"\x3EEdit post\x3C/a\x3E', 'display:none');
		dropdown.add('movePost9156', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dmove_node&amp;node\x3D9156\" rel\x3D\"nofollow\"\x3EMove post\x3C/a\x3E', 'display:none');
		dropdown.add('deletePost9156', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deletePost(9156)\" rel\x3D\"nofollow\"\x3EDelete this post\x3C/a\x3E', 'display:none');
			dropdown.add('deleteRecursively9156', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"Nabble.deleteFromSite(9156)\" rel\x3D\"nofollow\"\x3EDelete this post and replies\x3C/a\x3E', 'display:none');
		dropdown.add('changePostDate9156', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dchange_post_date&amp;node\x3D9156\" rel\x3D\"nofollow\"\x3EChange post date\x3C/a\x3E', 'display:none');
		dropdown.add('print9156', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Dprint_post&amp;node\x3D9156\" rel\x3D\"nofollow\"\x3EPrint post\x3C/a\x3E');
		dropdown.add('permalink9156', '\x3Ca href\x3D\"javascript: void(0)\" onclick\x3D\"prompt(\'Copy this:\',\'http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-tp8937p9156.html\')\"\x3EPermalink\x3C/a\x3E');
		dropdown.add('rawMail9156', '\x3Ca href\x3D\"/template/NamlServlet.jtp?macro\x3Draw_mail&amp;node\x3D9156\" rel\x3D\"nofollow\"\x3ERaw mail\x3C/a\x3E', 'display:none');
		dropdown.build('dd_postdropdown9156');
		dropdown.loadOnClick('/template/NamlServlet.jtp?macro=post_dropdown_later&node=9156' + Nabble.getClientID() + '&_=' + Math.floor(Math.random()*999999));
	</script>
					&nbsp;
					<img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/flag_gray.png" class="report-flag" onclick="Nabble.reportContent(9156)">
	<div id="tooltip51949" class="nabble-tooltip" use_title="false">
		Report Content as Inappropriate
		<div class="nabble-tooltip-arrow">
			<div class="d1">♦</div>
			<div class="d2">♦</div>
		</div>
	</div>
	<script type="text/javascript">
		Nabble.startTooltip(Nabble.get('tooltip51949'), 'up', 400);
	</script>
				</div>
				<div class="classic-subject-line">
					<span id="red-arrow9156" class="float-left invisible" style="margin-top:.2em">
		<img title="Selected post" width="15" height="15" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/arrow.png" alt="Selected post">
	</span>
					<span class="post-date float-left">
		<span id="d1404893780000-437">Jul 09, 2014; 4:16pm</span><script type="text/javascript">
		Nabble.get('d1404893780000-437').innerHTML= Nabble.formatDateLong(new Date(1404893780000));
	</script>
	</span>
					<h2 class="post-subject float-left adbayes-content" style="width:30%;overflow:visible;font-family:inherit"><span>
		Re: Which is the best way to get a connection to an external database per task in Spark Streaming?
	</span></h2>
				</div>
			</div>
		</div>
		<table class="classic-body">
			<tbody><tr>
				<td class="classic-author shaded-bg-color rounded-bottom">
					<div class="avatar-outer">
		<div class="avatar-inner">
			<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=user_nodes&user=1461" rel="nofollow" title="View profile of Juan Rodríguez Hortalá" class="nowrap no-decoration"><img class="avatar medium-border-color" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/c604bb117ab89bb656c33c7a95cbf384" height="100" width="100" alt="Juan Rodríguez Hortalá" title="Juan Rodríguez Hortalá"><img src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/online.png" class="online1461 online invisible" title="User is online" alt="online"></a>

	
	
		</div>
	</div>
	
	
	<div class="post-count1461 avatar-label weak-color">13 posts</div>
	
				</td>
				<td class="classic-message">
					
	
	
	<div id="message9156" class="message-text adbayes-content"><span>
		</span><div dir="ltr"><span>Hi Jerry, it's all clear to me now, I will try with something like Apache DBCP for the connection pool</span><br><br><span>Thanks a lot for your help!</span></div><div class="gmail_extra"><br><br><div class="gmail_quote"><span>2014-07-09 3:08 GMT+02:00 Shao, Saisai </span><span dir="ltr"><span>&lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=0" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;</span></span><span>:</span><br><span>
</span><blockquote class="gmail_quote" style="margin:0 0 0 .8ex;border-left:1px #ccc solid;padding-left:1ex"><span>





</span><div link="blue" vlink="purple" lang="ZH-CN"><span>
</span><div><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Yes, that would be the Java equivalence to use static class member, but you should carefully program to prevent resource leakage. A good choice
 is to use third-party DB connection library which supports connection pool, that will alleviate your programming efforts.</span><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Thanks</span><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Jerry</span><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><p class="MsoNormal"><b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;" lang="EN-US"><span>From:</span></span></b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;" lang="EN-US"><span> Juan Rodríguez Hortalá [mailto:</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=1" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>]
</span><br><span>
</span><b><span>Sent:</span></b><span> Tuesday, July 08, 2014 6:54 PM</span><br><span>
</span><b><span>To:</span></b><span> </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=2" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a></span></p><div><div class="h5"><br><span>
</span><b><span>Subject:</span></b><span> Re: Which is the best way to get a connection to an external database per task in Spark Streaming?</span><u></u><u></u></div></div><p></p><div><div class="h5"><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi Jerry, thanks for your answer. I'm using Spark Streaming for Java, and I only have rudimentary knowledge about Scala, how could I recreate in Java the lazy creation of a singleton object
 that you propose for Scala? Maybe a static class member in Java for the connection would be the solution?
</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Thanks again for your help,
</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Best Regards,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>2014-07-08 11:44 GMT+02:00 Shao, Saisai &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=3" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;:</span><u></u><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>I think you can maintain a connection pool or keep the connection as a long-lived object
 in executor side (like lazily creating a singleton object in object { } in Scala), so your task can get this connection each time executing a task, not creating a new one, that would be good for your scenario, since create a connection is quite expensive for
 each task.</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>&nbsp;</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Thanks</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>Jerry</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><span style="font-size:10.5pt;font-family:&quot;Calibri&quot;,&quot;sans-serif&quot;;color:#1f497d" lang="EN-US"><span>&nbsp;</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span><p class="MsoNormal"><b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;" lang="EN-US"><span>From:</span></span></b><span style="font-size:10.0pt;font-family:&quot;Tahoma&quot;,&quot;sans-serif&quot;" lang="EN-US"><span> Juan
 Rodríguez Hortalá [mailto:</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=4" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>]
</span><br><span>
</span><b><span>Sent:</span></b><span> Tuesday, July 08, 2014 5:19 PM</span><br><span>
</span><b><span>To:</span></b><span> Tobias Pfeiffer</span><br><span>
</span><b><span>Cc:</span></b><span> </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=5" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><br><span>
</span><b><span>Subject:</span></b><span> Re: Which is the best way to get a connection to an external database per task in Spark Streaming?</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi Tobias, thanks for your help. I understand that with that code we obtain a database connection per partition, but I also suspect that with that code a new database
 connection is created per each execution of the function used as argument for mapPartitions(). That would be very inefficient because a new object and a new database connection would be created for each batch of the DStream. But my knowledge about the lifecycle
 of Functions in Spark Streaming is very limited, so maybe I'm wrong, what do you think?
</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><u></u><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>2014-07-08 3:30 GMT+02:00 Tobias Pfeiffer &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=6" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;:</span><u></u><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan,</span><u></u><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>I am doing something similar, just not "insert into SQL database", but "issue some RPC call". I think mapPartitions() may be helpful to you. You could do something
 like</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>dstream.mapPartitions(iter =&gt; {</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; val db = new DbConnection()</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; // maybe only do the above if !iter.isEmpty</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; iter.map(item =&gt; {</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; db.call(...)</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; // do some cleanup if !iter.hasNext here</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; &nbsp; item</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp; })</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>}).count() // force output</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Keep in mind though that the whole idea about <span class="bold highlight search-highlight">RDDs</span> is that operations are idempotent and in theory could be run on multiple hosts (to take the result from the
 fastest server) or multiple times (to deal with failures/timeouts) etc., which is maybe something you want to deal with in your SQL.</span><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="color:#888888" lang="EN-US"><span>&nbsp;</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="color:#888888" lang="EN-US"><span>Tobias</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span></div><span>
</span><div><span>
</span><p class="MsoNormal"><span style="color:#888888" lang="EN-US"><span>&nbsp;</span></span><span lang="EN-US"><u></u><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>On Tue, Jul 8, 2014 at 3:40 AM, Juan Rodríguez Hortalá &lt;</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/user/SendEmail.jtp?type=node&node=9156&i=7" target="_top" rel="nofollow" link="external"><span>[hidden email]</span></a><span>&gt;
 wrote:</span><u></u><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Hi list,</span><br><span>
</span><br><span>
I'm writing a Spark Streaming program that reads from a kafka topic, performs some transformations on the data, and then inserts each record in a database with foreachRDD. I was wondering which is the best way to handle the connection to the database so each
 worker, or even each task, uses a different connection to the database, and then database inserts/updates would be performed in parallel.
</span><br><span>
- I understand that using a final variable in the driver code is not a good idea because then the communication with the database would be performed in the driver code, which leads to a bottleneck, according to
</span><a href="http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/" target="_blank" rel="nofollow" link="external"><span>
http://engineering.sharethrough.com/blog/2013/09/13/top-3-troubleshooting-tips-to-keep-you-sparking/</span></a><br><span>
- I think creating a new connection in the call() method of the Function passed to foreachRDD is also a bad idea, because then I wouldn't be reusing the connection to the database for each batch <span class="bold highlight search-highlight">RDD</span> in the DStream</span><br><span>

- I'm not sure that a broadcast variable with the connection handler is a good idea in case the target database is distributed, because if the same handler is used for all the nodes of the Spark cluster then than could have a negative effect in the data locality
 of the connection to the database.</span><br><span>
- From </span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Database-connection-per-worker-td1280.html</span></a><span> I understand that by using an static variable and referencing it in the call() method of the Function passed to foreachRDD we get a different connection per Spark
 worker, I guess it's because there is a different JVM per worker. But then all the tasks in the same worker would share the same database handler object, am I right?</span><br><span>
- Another idea is using updateStateByKey() using the database handler as the state, but I guess that would only work for Serializable database handlers, and for example not for an org.apache.hadoop.hbase.client.HTable object.
</span><br><span>
</span><br><span>
So my question is, which is the best way to get a connection to an external database per task in Spark Streaming? Or at least per worker. In
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Connecting-to-an-inmemory-database-from-Spark-td1343.html</span></a><span> there is a partial solution to this question, but there the database handler object is missing. This other question
</span><a href="http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html" target="_blank" rel="nofollow" link="external"><span>
http://apache-spark-user-list.1001560.n3.nabble.com/Spark-Streaming-Shared-hashmaps-td3247.html</span></a><span> is closer to mine, but there is no answer for it yet</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Thanks in advance,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal" style="margin-bottom:12.0pt"><span lang="EN-US"><span>Greetings,</span><u></u><u></u></span></p><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>Juan</span><u></u><u></u></span></p><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><span>&nbsp;</span><u></u><u></u></span></p><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span></div><span>
</span><p class="MsoNormal"><span lang="EN-US"><u></u><span>&nbsp;</span><u></u></span></p><span>
</span></div><span>
</span></div></div></div><span>
</span></div><span>

</span></blockquote></div><br></div><span>


	
	
	
	</span></div>
	
			<script type="text/javascript">
				Nabble.ads('last_classic_message');
			</script><div class="ad  div926738" style="display:block !important;visibility:visible !important;height:auto !important; width: auto !important;position:static !important;top:auto !important;left:auto !important;text-align:left;padding-top:1em;">
<a id="ad926738" href="http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-td8937.html#" style="display:none">.</a>
<script type="text/javascript" src="http://pagead2.googlesyndication.com/pagead/show_ads.js"></script><style type="text/css">.nabble .div926738 ins { display:inline-table !important; visibility: visible !important; height:90px !important; width: 728px !important; position:static !important;top:auto !important;left:auto !important; }.nabble .div926738 ins ins iframe { display:block !important; visibility: visible !important; height:90px !important; width: 728px !important; position:static !important;top:auto !important;left:auto !important; }</style><div style="padding-top:.3em;font-size:90%;clear:both"><a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=buy_credits_page">Remove Ads</a></div>
</div>

				</td>
			</tr>
		</tbody></table>
	</div>
	
		
	</div>
	</div>
			<div id="topic-footer" class="weak-color" style="padding-top:1em">
		«
		<a href="http://apache-spark-user-list.1001560.n3.nabble.com/">Return to Apache Spark User List</a>
		&nbsp;|&nbsp;
		<span id="v8937" style="">354 views</span>
	
	
	</div>
			<div id="report-inappropriate-content" class="report-inappropriate-content rounded">
		<div id="report-inappropriate-content-inner" class="no-bg-color medium-border-color border2">
			<div class="big">Loading...</div>
		</div>
	</div>
				<script type="text/javascript">
				Nabble.ads('topic_bottom');
			</script>
			<table class="footer-table shaded-bg-color">
		<tbody><tr>
			<td class="footer-left weak-color">
				Powered by
				<a href="http://www.nabble.com/" target="_top">Nabble</a>
			</td>
			<td class="footer-right">
				<a href="http://apache-spark-user-list.1001560.n3.nabble.com/template/NamlServlet.jtp?macro=macro_viewer&id=classic_forum_topic%21nabble%3Atopic.naml&base=nabble.view.web.template.ServletNamespace" rel="nofollow">Edit this page</a>
			</td>
		</tr>
	</tbody></table>
	<!-- Ad.true -->
			<script type="text/javascript">
var scriptUrl = '/template/NamlServlet.jtp?macro=js_page&searchSpecial=8937&incViewCount=8937&newsflash=&visitorOnline=&avatarOnline=1461|943|5&postCount=1461|943|5&markVisited=9156&views=8937';
scriptUrl += '&_=' + Math.floor(Math.random()*9999) + Nabble.getClientID();
$.getScript(scriptUrl, function() { Nabble.resizeFrames(); });
</script>

					<a id="not-visited" class="invisible" href="http://apache-spark-user-list.1001560.n3.nabble.com/any-url">x</a> <a id="visited" class="visited-link invisible" href="http://apache-spark-user-list.1001560.n3.nabble.com/Which-is-the-best-way-to-get-a-connection-to-an-external-database-per-task-in-Spark-Streaming-td8937.html#">x</a></div>
					<script type="text/javascript">
		$(document).ready(function() { Nabble.fixCookieClientID(); });
		(function(){ var sNew = document.createElement("script"); sNew.defer = true; sNew.src = "http://tag.crsspxl.com/s1.js?d=1294"; var s0 = document.getElementsByTagName('script')[0]; s0.parentNode.insertBefore(sNew, s0); })();
	</script>
					<!-- n3.nabble.com | Site ID = 1001560 -->
				
			<iframe width="1" height="1" frameborder="0" style="visibility:hidden;position:absolute;border:medium none" src="./Apache Spark User List - Which is the best way to get a connection to an external database per task in Spark Streaming _files/s2.htm"></iframe></body></html>