!function(t){"use strict";var e=function(e){this.element=t(e)};e.prototype={constructor:e,show:function(){var e,n,i,r=this.element,o=r.closest("ul:not(.dropdown-menu)"),a=r.attr("data-target");a||(a=r.attr("href"),a=a&&a.replace(/.*(?=#[^\s]*$)/,"")),r.parent("li").hasClass("active")||(e=o.find(".active:last a")[0],i=t.Event("show",{relatedTarget:e}),r.trigger(i),i.isDefaultPrevented()||(n=t(a),this.activate(r.parent("li"),o),this.activate(n,n.parent(),function(){r.trigger({type:"shown",relatedTarget:e})})))},activate:function(e,n,i){function r(){o.removeClass("active").find("> .dropdown-menu > .active").removeClass("active"),e.addClass("active"),a?(e[0].offsetWidth,e.addClass("in")):e.removeClass("fade"),e.parent(".dropdown-menu")&&e.closest("li.dropdown").addClass("active"),i&&i()}var o=n.find("> .active"),a=i&&t.support.transition&&o.hasClass("fade");a?o.one(t.support.transition.end,r):r(),o.removeClass("in")}};var n=t.fn.tab;t.fn.tab=function(n){return this.each(function(){var i=t(this),r=i.data("tab");r||i.data("tab",r=new e(this)),"string"==typeof n&&r[n]()})},t.fn.tab.Constructor=e,t.fn.tab.noConflict=function(){return t.fn.tab=n,this},t(document).on("click.tab.data-api",'[data-toggle="tab"], [data-toggle="pill"]',function(e){e.preventDefault(),t(this).tab("show")})}(window.jQuery),function(){Maleskine.ShareScripts={share:function(t,e,n,i,r,o,a){var s,l;return e=e.replace(/'/,"%2527"),l=o?I18n.t("reading.social_sharing.self_share_note_text",{note_title:e}):I18n.t("reading.social_sharing.reader_share_note_text",{note_title:e,user:r}),l+=Maleskine.Settings.mention_official_account(t),null!=n&&(n=n.replace(/'/,"%2527"),l=""+l+" \u300c"+n+"\u300d"),s=Maleskine.ShareScripts.getShareUrl(t,e,n,l,i,a),"javascript:void(function(){var d=document;var r='"+s+"';var x=function(){if(!window.open(r,'"+t+"','toolbar=0,status=0,resizable=1,scrollbars=yes,status=1,width=440,height=430,left='+(screen.width-440)/2+',top='+(screen.height-430)/2))location.href=r};if(/Firefox/.test(navigator.userAgent)){setTimeout(x,0)}else{x()}}())"},getShareUrl:function(t,e,n,i,r,o){var a;switch(e=encodeURIComponent(e),i=encodeURIComponent(i),r=encodeURIComponent(r+("?utm_campaign=maleskine&utm_content=note&utm_medium=reader_share&utm_source="+t)),t){case"weibo":return a="http://service.weibo.com/share/share.php?appkey="+Maleskine.Settings.weibo.appKey+"&title="+encodeURIComponent(i)+"&url="+encodeURIComponent(r)+"&searchPic=false&style=simple",o.length>0&&(a+="&pic="+encodeURIComponent(o[0])),a;case"twitter":return null!=n?"http://twitter.com/share?url="+r+"&text="+i+"&related=jianshucom":"http://twitter.com/share?url="+encodeURIComponent(r)+"&text="+i+"&related=jianshucom";case"douban":return"http://www.douban.com/recommend/?url="+encodeURIComponent(r)+"&title="+e+"&v=1";case"tweibo":return"http://share.v.t.qq.com/index.php?c=share&a=index&url="+encodeURIComponent(r)+"&title="+i;case"qzone":return"http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url="+encodeURIComponent(r)+"&title="+i;case"facebook":return"http://www.facebook.com/sharer.php?s=100&p[url]="+encodeURIComponent(r)+"&p[title]="+e+"&p[summary]="+i;case"google_plus":return"http://plus.google.com/share?url="+encodeURIComponent(r);case"renren":return"http://widget.renren.com/dialog/share?resourceUrl="+encodeURIComponent(r)+"&description="+i+"&title="+e}}}}.call(this),function(t){function e(t){this.text=t}t.holySelection={init:function(){t.holySelection.getSelection=window.getSelection?t.holySelection._getSelection:t.holySelection._getSelectionIE8},_getSelection:function(){return new e(window.getSelection().toString())},_getSelectionIE8:function(){return new e(document.selection.createRange().text)}}}(jQuery),$.holySelection.init(),function(t){var e=-2,n=-1,i=2,r=1,o=0,a=!1;t(document).on("compositionstart",function(){a=!0}),t(document).on("compositionend",function(){a=!1});var s=function(e){if(!t.popline.utils.isNull(t.popline.current)){var n=t.popline.instances[0].target,i=t(n).offset().top<=e.pageY&&t(n).offset().top+t(n).height()>=e.pageY,r=t.contains(t.popline.current.bar.get(0),e.target)||t.popline.current.bar.get(0)===e.target;if(t.popline.current.currentSelection=t.holySelection.getSelection(),(i||r)&&t.popline.current.currentSelection.text.length>0&&!t.popline.current.keepSlientWhenBlankSelected()){var o=(t.popline.current.target,t.popline.current.bar);if(o.is(":hidden")||o.is(":animated")){o.stop(!0,!0);var a=u().mouseup(e);t.popline.current.show(a)}}else t.popline.hideAllBar()}},l={mousedown:function(){t.popline.current=t(this).data("popline"),t.popline.hideAllBar()},keyup:function(e){{var n=t(this).data("popline");n.bar}if(!a&&window.getSelection().toString().length>0&&!n.keepSlientWhenBlankSelected()){var i=u().keyup(e);t.popline.current.show(i)}else t.popline.current.hide()},keydown:function(){var e=window.getSelection().getRangeAt(0).getClientRects();e.length>0&&t(this).data("lastKeyPos",t.popline.boundingRect())}},u=function(){var o=t.popline.current.target,a=t.popline.current.bar,s=t.popline.current.settings.position,l={fixed:{mouseup:function(t){var e=window.getSelection().getRangeAt(0).getBoundingClientRect(),n=t.pageX-a.width()/2,i=document.body.scrollTop||document.documentElement.scrollTop;0>n&&(n=10);var r=i+e.top-a.outerHeight()-10;return{left:n,top:r}},keyup:function(){var o=null,s=null,l=t.popline.getRect(),u=t.popline.current.isKeyMove();u===r||u===i?o=l.right-a.width()/2:(u===n||u===e)&&(o=l.left-a.width()/2);var h=document.body.scrollTop||document.documentElement.scrollTop;return s=h+l.top-a.outerHeight()-10,{left:o,top:s}}},relative:{mouseup:function(t){var e=t.pageX-a.width()/2;0>e&&(e=10);var n=t.pageY-a.outerHeight()-parseInt(o.css("font-size"))/2;return{left:e,top:n}},keyup:function(){var s=null,l=null,u=t.popline.getRect(),h=t.popline.current.isKeyMove();return h===r||h===i?(s=u.right-a.width()/2,l=t(document).scrollTop()+u.bottom-a.outerHeight()-parseInt(o.css("font-size"))):(h===n||h===e)&&(s=u.left-a.width()/2,l=t(document).scrollTop()+u.top-a.outerHeight()),{left:s,top:l}}}};return l[s]};t.fn.popline=function(e){_arguments=arguments,this.each(function(){if(_arguments.length>=1&&"string"==typeof _arguments[0]&&t(this).data("popline")){var n=t(this).data("popline")[_arguments[0]];"function"==typeof n&&n.apply(t(this).data("popline"),Array.prototype.slice.call(_arguments,1))}else if(!t(this).data("popline")){new t.popline(e,this)}}),t(document).data("popline-global-binded")||(t(document).mouseup(function(t){var e=this;setTimeout(function(){s.call(e,t)},1)}),t(document).data("popline-global-binded",!0))},t.popline=function(e,n){this.settings=t.extend(!0,{},t.popline.defaults,e),this.setPosition(this.settings.position),this.target=t(n),this.init(),t.popline.addInstance(this)},t.extend(t.popline,{defaults:{zIndex:9999,mode:"edit",enable:null,disable:null,position:"fixed",keepSlientWhenBlankSelected:!0},instances:[],current:null,prototype:{init:function(){this.bar=t("<ul class='popline' style='z-index:"+this.settings.zIndex+"'></ul>").appendTo("body"),this.bar.data("popline",this),this.target.data("popline",this);var e=this,n=function(e,i){if(null===e)return!0;for(var r=0,o=e.length;o>r;r++){var a=e[r];if("string"==typeof a&&i===a)return!0;if(t.isArray(a)&&n(a,i))return!0}return!1},i=function(e,n){if(null===e)return!1;for(var r=0,o=e.length;o>r;r++){var a=e[r];if("string"==typeof a&&n===a)return!0;if(t.isArray(a)){if((1===a.length||!t.isArray(a[1]))&&i(a,n))return!0;if(i(a.slice(1),n))return!0}}return!1},r=function(o,a){for(var s in a){var l=a[s],u=t.popline.utils.isNull(l.mode)?t.popline.defaults.mode:l.mode;if(u===e.settings.mode&&n(this.settings.enable,s)&&!i(this.settings.disable,s)){var h=t("<li><span class='btn'></span></li>");h.addClass("popline-button popline-"+s+"-button"),l.iconClass&&h.children(".btn").append("<i class='"+l.iconClass+"'></i>"),l.text&&h.children(".btn").append("<span class='text "+(l.textClass||"")+"'>"+l.text+"</span>"),l.bgColor&&h.css({"background-color":l.bgColor}),t.isFunction(l.beforeShow)&&this.beforeShowCallbacks.push({name:s,callback:l.beforeShow}),t.isFunction(l.afterHide)&&this.afterHideCallbacks.push({name:s,callback:l.afterHide}),h.appendTo(o),l.buttons?($subbar=t("<ul class='subbar'></ul>"),h.append($subbar),r.call(this,$subbar,l.buttons),h.click(function(n){var i=this;t(this).hasClass("boxed")||(e.switchBar(t(this),function(){t(i).siblings("li").hide().end().children(".btn").hide().end().children("ul").show().end()}),n.stopPropagation())})):t.isFunction(l.action)&&h.click(function(t){return function(n){t.action.call(this,n,e)}}(l)),h.mousedown(function(e){t(e.target).is("input")||e.preventDefault()}),h.mouseup(function(t){t.stopPropagation()})}}};r.call(this,this.bar,t.popline.buttons),this.target.bind(l),this.bar.on("mouseenter","li",function(){t(this).hasClass("boxed")||t(this).addClass("hover")}),this.bar.on("mouseleave","li",function(){t(this).hasClass("boxed")||t(this).removeClass("hover")})},show:function(t){for(var e=0,n=this.beforeShowCallbacks.length;n>e;e++){var i=this.beforeShowCallbacks[e],r=this.bar.find("li.popline-"+i.name+"-button");i.callback.call(r,this)}this.bar.css("top",t.top+"px").css("left",t.left+"px").stop(!0,!0).fadeIn()},hide:function(){var t=this;this.bar.is(":visible")&&!this.bar.is(":animated")&&this.bar.fadeOut(function(){t.bar.find("li").removeClass("boxed").show(),t.bar.find(".subbar").hide(),t.bar.find(".textfield").hide(),t.bar.find(".btn").show();for(var e=0,n=t.afterHideCallbacks.length;n>e;e++){var i=t.afterHideCallbacks[e],r=t.bar.find("li.popline-"+i.name+"-button");i.callback.call(r,t)}})},destroy:function(){this.target.unbind(l),this.target.removeData("popline"),this.target.removeData("lastKeyPos"),this.bar.remove()},switchBar:function(t,e,n){if("function"==typeof e){var i=this,r=parseInt(i.bar.css("left"))+i.bar.width()/2;i.bar.animate({opacity:0,marginTop:-i.bar.height()+"px"},function(){e.call(this),t.removeClass("hover").addClass("boxed").show(),i.bar.css("margin-top",i.bar.height()+"px"),i.bar.css("left",r-i.bar.width()/2+"px"),"function"==typeof n?i.bar.animate({opacity:1,marginTop:0},n):i.bar.animate({opacity:1,marginTop:0})})}},keepSlientWhenBlankSelected:function(){return this.settings.keepSlientWhenBlankSelected&&""===t.trim(t.popline.current.currentSelection.text)?!0:!1},isKeyMove:function(){var a=this.target.data("lastKeyPos");return currentRect=t.popline.boundingRect(),t.popline.utils.isNull(a)?null:currentRect.top===a.top&&currentRect.bottom!==a.bottom?r:currentRect.bottom===a.bottom&&currentRect.top!==a.top?n:currentRect.right!==a.right?i:currentRect.left!==a.left?e:o},setPosition:function(t){this.settings.position="relative"===t?"relative":"fixed"},beforeShowCallbacks:[],afterHideCallbacks:[]},hideAllBar:function(){for(var e=0,n=t.popline.instances.length;n>e;e++)t.popline.instances[e].hide()},addInstance:function(e){t.popline.instances.push(e)},boundingRect:function(e){return t.popline.utils.isNull(e)&&(e=window.getSelection().getRangeAt(0).getClientRects()),{top:parseInt(e[0].top),left:parseInt(e[0].left),right:parseInt(e[e.length-1].right),bottom:parseInt(e[e.length-1].bottom)}},webkitBoundingRect:function(){for(var e=window.getSelection().getRangeAt(0).getClientRects(),n=[],i=0,r=e.length;r>i;i++){var o=e[i];0!==o.width&&(0!==i&&i!==e.length-1||1!==o.width)&&n.push(o)}return t.popline.boundingRect(n)},getRect:function(){return t.popline.utils.browser.firefox||t.popline.utils.browser.opera?t.popline.boundingRect():t.popline.utils.browser.chrome||t.popline.utils.browser.safari?t.popline.webkitBoundingRect():void 0},utils:{isNull:function(t){return"undefined"==typeof t||null===t?!0:!1},randomNumber:function(){return Math.floor(1e7*Math.random()+1)},trim:function(t){return t.replace(/^\s+|\s+$/g,"")},browser:{chrome:navigator.userAgent.match(/chrome/i)?!0:!1,safari:navigator.userAgent.match(/safari/i)&&!navigator.userAgent.match(/chrome/i)?!0:!1,firefox:navigator.userAgent.match(/firefox/i)?!0:!1,opera:navigator.userAgent.match(/opera/i)?!0:!1,ie:navigator.userAgent.match(/msie/i)?!0:!1,webkit:navigator.userAgent.match(/webkit/i)?!0:!1},findNodeWithTags:function(e,n){for(t.isArray(n)||(n=[n]);e;){if(3!==e.nodeType){var i=n.indexOf(e.tagName);if(-1!==i)return e}e=e.parentNode}return null}},addButton:function(e){t.extend(t.popline.buttons,e)},buttons:{}})}(jQuery),function(){!function(t){return"function"==typeof define&&define.amd?define(["jquery"],t):t(window.jQuery)}(function(t){"use strict";var e,n,i,r,o,a,s,l,u,h,c;return h="caret",e=function(){function e(t){this.$inputor=t,this.domInputor=this.$inputor[0]}return e.prototype.setPos=function(){return this.domInputor},e.prototype.getIEPosition=function(){return t.noop()},e.prototype.getPosition=function(){return t.noop()},e.prototype.getOldIEPos=function(){var t,e;return e=s.selection.createRange(),t=s.body.createTextRange(),t.moveToElementText(this.domInputor),t.setEndPoint("EndToEnd",e),t.text.length},e.prototype.getPos=function(){var t,e,n;return(n=this.range())?(t=n.cloneRange(),t.selectNodeContents(this.domInputor),t.setEnd(n.endContainer,n.endOffset),e=t.toString().length,t.detach(),e):s.selection?this.getOldIEPos():void 0},e.prototype.getOldIEOffset=function(){var t,e;return t=s.selection.createRange().duplicate(),t.moveStart("character",-1),e=t.getBoundingClientRect(),{height:e.bottom-e.top,left:e.left,top:e.top}},e.prototype.getOffset=function(){var e,n,i,r;if(u.getSelection&&(i=this.range())){if(i.endOffset-1<0)return null;e=i.cloneRange(),e.setStart(i.endContainer,i.endOffset-1),e.setEnd(i.endContainer,i.endOffset),r=e.getBoundingClientRect(),n={height:r.height,left:r.left+r.width,top:r.top},e.detach()}else s.selection&&(n=this.getOldIEOffset());return n&&!l&&(n.top+=t(u).scrollTop(),n.left+=t(u).scrollLeft()),n},e.prototype.range=function(){var t;if(u.getSelection)return t=u.getSelection(),t.rangeCount>0?t.getRangeAt(0):null},e}(),n=function(){function e(t){this.$inputor=t,this.domInputor=this.$inputor[0]}return e.prototype.getIEPos=function(){var t,e,n,i,r,o,a;return e=this.domInputor,o=s.selection.createRange(),r=0,o&&o.parentElement()===e&&(i=e.value.replace(/\r\n/g,"\n"),n=i.length,a=e.createTextRange(),a.moveToBookmark(o.getBookmark()),t=e.createTextRange(),t.collapse(!1),r=a.compareEndPoints("StartToEnd",t)>-1?n:-a.moveStart("character",-n)),r},e.prototype.getPos=function(){return s.selection?this.getIEPos():this.domInputor.selectionStart},e.prototype.setPos=function(t){var e,n;return e=this.domInputor,s.selection?(n=e.createTextRange(),n.move("character",t),n.select()):e.setSelectionRange&&e.setSelectionRange(t,t),e},e.prototype.getIEOffset=function(t){var e,n,i,r;return n=this.domInputor.createTextRange(),t||(t=this.getPos()),n.move("character",t),i=n.boundingLeft,r=n.boundingTop,e=n.boundingHeight,{left:i,top:r,height:e}},e.prototype.getOffset=function(e){var n,i,r;return n=this.$inputor,s.selection?(i=this.getIEOffset(e),i.top+=t(u).scrollTop()+n.scrollTop(),i.left+=t(u).scrollLeft()+n.scrollLeft(),i):(i=n.offset(),r=this.getPosition(e),i={left:i.left+r.left-n.scrollLeft(),top:i.top+r.top-n.scrollTop(),height:r.height})},e.prototype.getPosition=function(t){var e,n,r,o,a,s;return e=this.$inputor,r=function(t){return t.replace(/</g,"&lt").replace(/>/g,"&gt").replace(/`/g,"&#96").replace(/"/g,"&quot").replace(/\r\n|\r|\n/g,"<br />")},void 0===t&&(t=this.getPos()),s=e.val().slice(0,t),o="<span>"+r(s)+"</span>",o+="<span id='caret'>|</span>",a=new i(e),n=a.create(o).rect()},e.prototype.getIEPosition=function(t){var e,n,i,r,o;return i=this.getIEOffset(t),n=this.$inputor.offset(),r=i.left-n.left,o=i.top-n.top,e=i.height,{left:r,top:o,height:e}},e}(),i=function(){function e(t){this.$inputor=t}return e.prototype.css_attr=["overflowY","height","width","paddingTop","paddingLeft","paddingRight","paddingBottom","marginTop","marginLeft","marginRight","marginBottom","fontFamily","borderStyle","borderWidth","wordWrap","fontSize","lineHeight","overflowX","text-align"],e.prototype.mirrorCss=function(){var e,n=this;return e={position:"absolute",left:-9999,top:0,zIndex:-2e4,"white-space":"pre-wrap"},t.each(this.css_attr,function(t,i){return e[i]=n.$inputor.css(i)}),e},e.prototype.create=function(e){return this.$mirror=t("<div></div>"),this.$mirror.css(this.mirrorCss()),this.$mirror.html(e),this.$inputor.after(this.$mirror),this},e.prototype.rect=function(){var t,e,n;return t=this.$mirror.find("#caret"),e=t.position(),n={left:e.left,top:e.top,height:t.height()},this.$mirror.remove(),n},e}(),r={contentEditable:function(t){return!(!t[0].contentEditable||"true"!==t[0].contentEditable)}},a={pos:function(t){return t||0===t?this.setPos(t):this.getPos()},position:function(t){return s.selection?this.getIEPosition(t):this.getPosition(t)},offset:function(e){var n,i;return i=this.getOffset(e),l&&(n=t(l).offset(),i.top+=n.top,i.left+=n.left),i}},s=null,u=null,l=null,c=function(t){return l=t,u=t.contentWindow,s=t.contentDocument||u.document},o=function(e,n){var i,r;if(t.isPlainObject(n)&&(r=n.iframe))return e.data("caret-iframe",r),c(r);if(r=e.data("caret-iframe"))return c(r);s=e[0].ownerDocument,u=s.defaultView||s.parentWindow;try{return l=u.frameElement}catch(o){i=o}},t.fn.caret=function(i){var s;return"object"==typeof i?(o(this,i),this):a[i]?(o(this),s=r.contentEditable(this)?new e(this):new n(this),a[i].apply(s,Array.prototype.slice.call(arguments,1))):t.error("Method "+i+" does not exist on jQuery.caret")},t.fn.caret.EditableCaret=e,t.fn.caret.InputCaret=n,t.fn.caret.Utils=r,t.fn.caret.apis=a})}.call(this),function(){!function(t){return"function"==typeof define&&define.amd?define(["jquery"],t):t(window.jQuery)}(function(t){var e,n,i,r,o,a,s,l,u,h=[].slice;i=function(){function e(e){this.current_flag=null,this.controllers={},this.alias_maps={},this.$inputor=t(e),this.iframe=null,this.setIframe(),this.listen()}return e.prototype.setIframe=function(t){var e;if(t)return this.window=t.contentWindow,this.document=t.contentDocument||this.window.document,this.iframe=t,this;this.document=this.$inputor[0].ownerDocument,this.window=this.document.defaultView||this.document.parentWindow;try{return this.iframe=this.window.frameElement}catch(n){e=n}},e.prototype.controller=function(t){return this.controllers[this.alias_maps[t]||t||this.current_flag]},e.prototype.set_context_for=function(t){return this.current_flag=t,this},e.prototype.reg=function(t,e){var n,i;return n=(i=this.controllers)[t]||(i[t]=new o(this,t)),e.alias&&(this.alias_maps[e.alias]=t),n.init(e),this},e.prototype.listen=function(){return this.$inputor.on("keyup.atwhoInner",function(t){return function(e){return t.on_keyup(e)}}(this)).on("keydown.atwhoInner",function(t){return function(e){return t.on_keydown(e)}}(this)).on("scroll.atwhoInner",function(t){return function(){var e;return null!=(e=t.controller())?e.view.hide():void 0}}(this)).on("blur.atwhoInner",function(t){return function(){var e;return(e=t.controller())?e.view.hide(e.get_opt("display_timeout")):void 0}}(this))},e.prototype.shutdown=function(){var t,e,n;n=this.controllers;for(e in n)t=n[e],t.destroy(),delete this.controllers[e];return this.$inputor.off(".atwhoInner")},e.prototype.dispatch=function(){return t.map(this.controllers,function(t){return function(e){var n;return(n=e.get_opt("delay"))?(clearTimeout(t.delayedCallback),t.delayedCallback=setTimeout(function(){return e.look_up()?t.set_context_for(e.at):void 0},n)):e.look_up()?t.set_context_for(e.at):void 0}}(this))},e.prototype.on_keyup=function(e){var n;switch(e.keyCode){case s.ESC:e.preventDefault(),null!=(n=this.controller())&&n.view.hide();break;case s.DOWN:case s.UP:case s.CTRL:t.noop();break;case s.P:case s.N:e.ctrlKey||this.dispatch();break;default:this.dispatch()}},e.prototype.on_keydown=function(e){var n,i;if(n=null!=(i=this.controller())?i.view:void 0,n&&n.visible())switch(e.keyCode){case s.ESC:e.preventDefault(),n.hide();break;case s.UP:e.preventDefault(),n.prev();break;case s.DOWN:e.preventDefault(),n.next();break;case s.P:if(!e.ctrlKey)return;e.preventDefault(),n.prev();break;case s.N:if(!e.ctrlKey)return;e.preventDefault(),n.next();break;case s.TAB:case s.ENTER:if(!n.visible())return;e.preventDefault(),n.choose();break;default:t.noop()}},e}(),o=function(){function n(n,i){this.app=n,this.at=i,this.$inputor=this.app.$inputor,this.id=this.$inputor[0].id||this.uid(),this.setting=null,this.query=null,this.pos=0,this.cur_rect=null,this.range=null,e.append(this.$el=t("<div id='atwho-ground-"+this.id+"'></div>")),this.model=new l(this),this.view=new u(this)}return n.prototype.uid=function(){return(Math.random().toString(16)+"000000000").substr(2,8)+(new Date).getTime()},n.prototype.init=function(e){return this.setting=t.extend({},this.setting||t.fn.atwho["default"],e),this.view.init(),this.model.reload(this.setting.data)},n.prototype.destroy=function(){return this.trigger("beforeDestroy"),this.model.destroy(),this.view.destroy(),this.$el.remove()},n.prototype.call_default=function(){var e,n,i;i=arguments[0],e=2<=arguments.length?h.call(arguments,1):[];try{return a[i].apply(this,e)}catch(r){return n=r,t.error(""+n+" Or maybe At.js doesn't have function "+i)}},n.prototype.trigger=function(t,e){var n,i;return null==e&&(e=[]),e.push(this),n=this.get_opt("alias"),i=n?""+t+"-"+n+".atwho":""+t+".atwho",this.$inputor.trigger(i,e)},n.prototype.callbacks=function(t){return this.get_opt("callbacks")[t]||a[t]},n.prototype.get_opt=function(t){var e;try{return this.setting[t]}catch(n){return e=n,null}},n.prototype.content=function(){return this.$inputor.is("textarea, input")?this.$inputor.val():this.$inputor.text()},n.prototype.catch_query=function(){var t,e,n,i,r,o;return e=this.content(),t=this.$inputor.caret("pos"),o=e.slice(0,t),i=this.callbacks("matcher").call(this,this.at,o,this.get_opt("start_with_space")),"string"==typeof i&&i.length<=this.get_opt("max_len",20)?(r=t-i.length,n=r+i.length,this.pos=r,i={text:i,head_pos:r,end_pos:n},this.trigger("matched",[this.at,i.text])):(i=null,this.view.hide()),this.query=i},n.prototype.rect=function(){var t,e;if(t=this.$inputor.caret({iframe:this.app.iframe}).caret("offset",this.pos-1))return"true"===this.$inputor.attr("contentEditable")&&(t=this.cur_rect||(this.cur_rect=t)||t),e=this.app.document.selection?0:2,{left:t.left,top:t.top,bottom:t.top+t.height+e}},n.prototype.reset_rect=function(){return"true"===this.$inputor.attr("contentEditable")?this.cur_rect=null:void 0},n.prototype.mark_range=function(){return"true"===this.$inputor.attr("contentEditable")&&(this.app.window.getSelection&&(this.range=this.app.window.getSelection().getRangeAt(0)),this.app.document.selection)?this.ie8_range=this.app.document.selection.createRange():void 0},n.prototype.insert_content_for=function(e){var n,i,r;return i=e.data("value"),r=this.get_opt("insert_tpl"),this.$inputor.is("textarea, input")||!r?i:(n=t.extend({},e.data("item-data"),{"atwho-data-value":i,"atwho-at":this.at}),this.callbacks("tpl_eval").call(this,r,n))},n.prototype.insert=function(e,n){var i,r,o,a,s,l,u,h,c,d,p;return i=this.$inputor,"true"===i.attr("contentEditable")&&(o="atwho-view-flag atwho-view-flag-"+(this.get_opt("alias")||this.at),a=""+e+"<span contenteditable='false'>&nbsp;<span>",s="<span contenteditable='false' class='"+o+"'>"+a+"</span>",r=t(s,this.app.document).data("atwho-data-item",n.data("item-data")),this.app.document.selection&&(r=t("<span contenteditable='true'></span>",this.app.document).html(r))),i.is("textarea, input")?(e=""+e,c=i.val(),d=c.slice(0,Math.max(this.query.head_pos-this.at.length,0)),p=""+d+e+" "+c.slice(this.query.end_pos||0),i.val(p),i.caret("pos",d.length+e.length+1)):(u=this.range)?(l=u.startOffset-(this.query.end_pos-this.query.head_pos)-this.at.length,u.setStart(u.endContainer,Math.max(l,0)),u.setEnd(u.endContainer,u.endOffset),u.deleteContents(),u.insertNode(r[0]),u.collapse(!1),h=this.app.window.getSelection(),h.removeAllRanges(),h.addRange(u)):(u=this.ie8_range)&&(u.moveStart("character",this.query.end_pos-this.query.head_pos-this.at.length),u.pasteHTML(a),u.collapse(!1),u.select()),i.is(":focus")||i.focus(),i.change()},n.prototype.render_view=function(t){var e;return e=this.get_opt("search_key"),t=this.callbacks("sorter").call(this,this.query.text,t.slice(0,1001),e),this.view.render(t.slice(0,this.get_opt("limit")))},n.prototype.look_up=function(){var e,n;if(e=this.catch_query())return n=function(t){return t&&t.length>0?this.render_view(t):this.view.hide()},this.model.query(e.text,t.proxy(n,this)),e},n}(),l=function(){function e(t){this.context=t,this.at=this.context.at,this.storage=this.context.$inputor}return e.prototype.destroy=function(){return this.storage.data(this.at,null)},e.prototype.saved=function(){return this.fetch()>0},e.prototype.query=function(t,e){var n,i,r;return n=this.fetch(),i=this.context.get_opt("search_key"),n=this.context.callbacks("filter").call(this.context,t,n,i)||[],r=this.context.callbacks("remote_filter"),n.length>0||!r&&0===n.length?e(n):r.call(this.context,t,e)},e.prototype.fetch=function(){return this.storage.data(this.at)||[]},e.prototype.save=function(t){return this.storage.data(this.at,this.context.callbacks("before_save").call(this.context,t||[]))},e.prototype.load=function(t){return!this.saved()&&t?this._load(t):void 0},e.prototype.reload=function(t){return this._load(t)},e.prototype._load=function(e){return"string"==typeof e?t.ajax(e,{dataType:"json"}).done(function(t){return function(e){return t.save(e)}}(this)):this.save(e)},e}(),u=function(){function e(e){this.context=e,this.$el=t("<div class='atwho-view'><ul class='atwho-view-ul'></ul></div>"),this.timeout_id=null,this.context.$el.append(this.$el),this.bind_event()}return e.prototype.init=function(){var t;return t=this.context.get_opt("alias")||this.context.at.charCodeAt(0),this.$el.attr({id:"at-view-"+t})},e.prototype.destroy=function(){return this.$el.remove()},e.prototype.bind_event=function(){var e;return e=this.$el.find("ul"),e.on("mouseenter.atwho-view","li",function(n){return e.find(".cur").removeClass("cur"),t(n.currentTarget).addClass("cur")}).on("click",function(t){return function(e){return t.choose(),e.preventDefault()}}(this))},e.prototype.visible=function(){return this.$el.is(":visible")},e.prototype.choose=function(){var t,e;return(t=this.$el.find(".cur")).length?(e=this.context.insert_content_for(t),this.context.insert(this.context.callbacks("before_insert").call(this.context,e,t),t),this.context.trigger("inserted",[t]),this.hide()):void 0},e.prototype.reposition=function(e){var n,i;return e.bottom+this.$el.height()-t(window).scrollTop()>t(window).height()&&(e.bottom=e.top-this.$el.height()),n={left:e.left,top:e.bottom},null!=(i=this.context.callbacks("before_reposition"))&&i.call(this.context,n),this.$el.offset(n),this.context.trigger("reposition",[n])},e.prototype.next=function(){var t,e;return t=this.$el.find(".cur").removeClass("cur"),e=t.next(),e.length||(e=this.$el.find("li:first")),e.addClass("cur")},e.prototype.prev=function(){var t,e;return t=this.$el.find(".cur").removeClass("cur"),e=t.prev(),e.length||(e=this.$el.find("li:last")),e.addClass("cur")},e.prototype.show=function(){var t;return this.context.mark_range(),this.visible()||(this.$el.show(),this.context.trigger("shown")),(t=this.context.rect())?this.reposition(t):void 0},e.prototype.hide=function(t){var e;return isNaN(t&&this.visible())?(this.context.reset_rect(),this.$el.hide(),this.context.trigger("hidden")):(e=function(t){return function(){return t.hide()}}(this),clearTimeout(this.timeout_id),this.timeout_id=setTimeout(e,t))},e.prototype.render=function(e){var n,i,r,o,a,s,l;if(!(t.isArray(e)&&e.length>0))return void this.hide();for(this.$el.find("ul").empty(),i=this.$el.find("ul"),a=this.context.get_opt("tpl"),s=0,l=e.length;l>s;s++)r=e[s],r=t.extend({},r,{"atwho-at":this.context.at}),o=this.context.callbacks("tpl_eval").call(this.context,a,r),n=t(this.context.callbacks("highlighter").call(this.context,o,this.context.query.text)),n.data("item-data",r),i.append(n);return this.show(),this.context.get_opt("highlight_first")?i.find("li:first").addClass("cur"):void 0},e}(),s={DOWN:40,UP:38,ESC:27,TAB:9,ENTER:13,CTRL:17,P:80,N:78},a={before_save:function(e){var n,i,r,o;if(!t.isArray(e))return e;for(o=[],i=0,r=e.length;r>i;i++)n=e[i],o.push(t.isPlainObject(n)?n:{name:n});return o},matcher:function(t,e,n){var i,r;return t=t.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),n&&(t="(?:^|\\s)"+t),r=new RegExp(t+"([A-Za-z0-9_+-]*)$|"+t+"([^\\x00-\\xff]*)$","gi"),i=r.exec(e),i?i[2]||i[1]:null},filter:function(t,e,n){var i,r,o,a;for(a=[],r=0,o=e.length;o>r;r++)i=e[r],~i[n].toLowerCase().indexOf(t.toLowerCase())&&a.push(i);return a},remote_filter:null,sorter:function(t,e,n){var i,r,o,a;if(!t)return e;for(a=[],r=0,o=e.length;o>r;r++)i=e[r],i.atwho_order=i[n].toLowerCase().indexOf(t.toLowerCase()),i.atwho_order>-1&&a.push(i);return a.sort(function(t,e){return t.atwho_order-e.atwho_order})},tpl_eval:function(t,e){var n;try{return t.replace(/\$\{([^\}]*)\}/g,function(t,n){return e[n]})}catch(i){return n=i,""}},highlighter:function(t,e){var n;return e?(n=new RegExp(">\\s*(\\w*)("+e.replace("+","\\+")+")(\\w*)\\s*<","ig"),t.replace(n,function(t,e,n,i){return"> "+e+"<strong>"+n+"</strong>"+i+" <"})):t},before_insert:function(t){return t}},n={load:function(t,e){var n;return(n=this.controller(t))?n.model.load(e):void 0},getInsertedItemsWithIDs:function(e){var n,i,r;return(n=this.controller(e))?(e&&(e="-"+(n.get_opt("alias")||n.at)),i=[],r=t.map(this.$inputor.find("span.atwho-view-flag"+(e||"")),function(e){var n;return n=t(e).data("atwho-data-item"),i.indexOf(n.id)>-1?void 0:(n.id&&(i.push=n.id),n)}),[i,r]):[null,null]},getInsertedItems:function(t){return n.getInsertedItemsWithIDs.apply(this,[t])[1]},getInsertedIDs:function(t){return n.getInsertedItemsWithIDs.apply(this,[t])[0]},setIframe:function(t){return this.setIframe(t)},run:function(){return this.dispatch()},destroy:function(){return this.shutdown(),this.$inputor.data("atwho",null)}},r={init:function(e){var n,r;return r=(n=t(this)).data("atwho"),r||n.data("atwho",r=new i(this)),r.reg(e.at,e),this}},e=t("<div id='atwho-container'></div>"),t.fn.atwho=function(i){var o,a;return a=arguments,t("body").append(e),o=null,this.filter("textarea, input, [contenteditable=true]").each(function(){var e;return"object"!=typeof i&&i?n[i]?(e=t(this).data("atwho"))?o=n[i].apply(e,Array.prototype.slice.call(a,1)):void 0:t.error("Method "+i+" does not exist on jQuery.caret"):r.init.apply(this,a)}),o||this},t.fn.atwho["default"]={at:void 0,alias:void 0,data:null,tpl:"<li data-value='${atwho-at}${name}'>${name}</li>",insert_tpl:"<span>${atwho-data-value}</span>",callbacks:a,search_key:"name",start_with_space:!0,highlight_first:!0,limit:5,max_len:20,display_timeout:300,delay:null}})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e={}.hasOwnProperty,n=function(t,n){function i(){this.constructor=t}for(var r in n)e.call(n,r)&&(t[r]=n[r]);return i.prototype=n.prototype,t.prototype=new i,t.__super__=n.prototype,t};Maleskine.CommentsList=function(e){function i(){this.insertEmoji=t(this.insertEmoji,this);var e,n;i.__super__.constructor.apply(this,arguments),this.emojiSet=["smile","blush","smiley","relaxed","wink","heart_eyes","kissing_heart","kissing_closed_eyes","flushed","grin","relieved","stuck_out_tongue_winking_eye","stuck_out_tongue_closed_eyes","unamused","smirk","sweat","pensive","confounded","disappointed_relieved","cold_sweat","fearful","persevere","cry","sob","joy","scream","angry","sleepy","mask","innocent","yum","anguished","frowning","hushed","dizzy_face","stuck_out_tongue","no_mouth","sunglasses","sweat_smile","worried","+1","-1","clap","v","pray","fist","heart","broken_heart","heartbeat","sparkling_heart","cupid","beer","beers","birthday","heavy_exclamation_mark","bangbang","interrobang","underage","no_bicycles","no_mobile_phones","u7981","up","sunny","moon","high_brightness","first_quarter_moon_with_face","zap","snowflake","cloud","tada","bear","cat","cow","dog","hamster","monkey_face","rabbit","tiger","turtle","whale","whale2","dolphin","crocodile","dragon_face","squirrel","hatching_chick","hatched_chick","baby_chick","frog","ant","bug","beetle","ghost","accept","airplane","alarm_clock","ambulance","angel","apple","arrows_counterclockwise","balloon","beginner","bikini","black_nib","blossom","bomb","boom","bow","bread","bulb","cake","cactus","camera","candy","checkered_flag","cherries","cherry_blossom","chocolate_bar","christmas_tree","clapper","closed_umbrella","closed_lock_with_key","clubs","cocktail","coffee","confetti_ball","crown","dancer","dancers","dart","doughnut","first_quarter_moon","fries","game_die","golf","guitar","gun","herb","hibiscus","high_heel","hocho","icecream","ideograph_advantage","jack_o_lantern","key","kiss","lock","lollipop","mag","moneybag","bell","no_bell","ribbon","skull","snowman","spaghetti","sparkles","strawberry","sunflower","sweat_drops","toilet","watermelon","anger","chart","corn","deciduous_tree","dash","dress","ear_of_rice","eyes","fallen_leaf","feet","fishing_pole_and_fish","hankey","heavy_check_mark","leaves","lipstick","mag_right","mailbox_with_mail","mailbox_with_no_mail","man_with_gua_pi_mao","metal","mushroom","musical_keyboard","on","arrow_right","arrow_left","arrow_up","arrow_down","atm","crystal_ball","eight_spoked_asterisk","octocat","crying_cat_face","heart_eyes_cat","joy_cat","scream_cat","smile_cat","smiley_cat","smirk_cat"],this.emojiInitialized=!1,window.location.hash.length>0&&$(window.location.hash).addClass("comment-active"),this.textarea.atwho({at:"@",data:this.textarea.data("user-names"),limit:10}).atwho({at:":",limit:10,tpl:"<li data-value=':${name}:'><img src='"+Maleskine.Settings.emoji_host+"/assets/emojis/${name}.png' height='20' width='20'/> ${name} </li>",data:Maleskine.Emoji}),this.deleteCommentLink.on("click",function(){var t;
if(confirm(I18n.t("reading.delete_comment_confirm")))return t=$(this).parent().parent().parent(),$.ajax({url:$(this).data("url"),type:"DELETE",async:!0,complete:function(e,n){return"success"===n?$(t).hide("slow"):void 0}})}),this.replyCommentLink.on("click",function(t){return function(e){var n,i;return n=$(e.currentTarget),t.textarea.focus(),i=t.textarea.val(),i.length>1&&" "!==i[i.length-1]&&(i+=" "),t.textarea.val(i+("@"+n.data("nickname")+" "))}}(this)),$("#emoji-modal").on("show",function(t){return function(){return t.emojiInitialized?void 0:t.insertEmoji()}}(this)),e=function(t){return function(){var e,n;return n=rangy.getSelection(t.textarea[0]),e=n&&n.rangeCount&&n.getRangeAt(0)}}(this),n=function(){return function(t,e){var n,i,r;return document.selection?(t.focus(),i=document.selection.createRange(),i.text=e):t.selectionStart||"0"===t.selectionStart?(r=t.selectionStart,n=t.selectionEnd,t.value=t.value.substring(0,r)+e+t.value.substring(n,t.value.length),t.selectionStart=n+e.length,t.selectionEnd=n+e.length):t.value+=e}}(this),$("#emoji-modal").on("mousedown","[data-emoji-name]",function(t){return function(e){var i;return e.preventDefault(),i=" :"+$(e.currentTarget).data("emoji-name")+": ",n(t.textarea[0],i),t.emojiModal.modal("hide")}}(this)),this.el.on("ajax:success",".dismiss",function(){return function(t,e){var n,i;return n=$("#comment-"+e.id),n.fadeOut("slow",function(){return n.hide()}),i="<a href='"+Routes.undismiss_comment_path(e.id)+"' class='undismiss' data-method='post' data-remote='true' data-type='json' rel='nofollow'>"+I18n.t("reading.comment.undismiss_button")+"</a>",noty({text:I18n.t("reading.comment.dismiss_info")+"\u30fb"+i,layout:"topCenter",type:"information",timeout:5500,closeWith:[],theme:"maleskineTheme"})}}(this)),this.el.on("ajax:error",".dismiss",function(t){return function(e,n){return t.notyError($.parseJSON(n.responseText).errors[0])}}(this)),$("body").on("ajax:success",".undismiss",function(t){return function(e,n){var i;return i=$("#comment-"+n.id),i.fadeOut("slow",function(){return i.show()}),$(e.currentTarget).closest("ul").remove(),t.notyInfo(I18n.t("reading.comment.undismiss_info"))}}(this)),$("body").on("ajax:error",".undismiss",function(t){return function(e,n){return t.notyError($.parseJSON(n.responseText).errors[0])}}(this))}return n(i,e),i.prototype.elements={textarea:"textarea","a.delete":"deleteCommentLink","a.reply":"replyCommentLink","button[type=submit]":"commentSubmitButton","#emoji-modal":"emojiModal"},i.prototype.events={"keydown textarea":"submitCommentHotkey"},i.prototype.insertEmoji=function(){var t,e,n,i,r,o,a,s,l,u,h,c;for(o=$("#emojiTabContent ul"),h=[0,1,2,3],a=0,l=h.length;l>a;a++){for(i=h[a],r=50*i,n=50*(i+1)-1,e="",c=this.emojiSet.slice(r,+n+1||9e9),s=0,u=c.length;u>s;s++)t=c[s],e=""+e+"<li><a href='javascript:void(null)' data-emoji-name='"+t+"'><img src='"+Maleskine.Settings.emoji_host+"/assets/emojis/"+t+".png' alt=':"+t+":' title='"+t+"' class='emoji'></a></li>";$(o[i]).append(e)}return this.emojiInitialized=!0},i.prototype.submitCommentHotkey=function(t){if(Maleskine.BrowserDetector.isMac()){if(t.metaKey&&13===t.keyCode)return this.commentSubmitButton.trigger("click")}else if((10===t.keyCode||13===t.keyCode)&&t.ctrlKey)return this.commentSubmitButton.trigger("click")},i}(Maleskine.BaseModule)}.call(this),function(){var __bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};Maleskine.NoteShow=function(_super){function NoteShow(){this.setFurtherReadingState=__bind(this.setFurtherReadingState,this),this.hideStateDropdown=__bind(this.hideStateDropdown,this),this.showStateDropdown=__bind(this.showStateDropdown,this),this.pasteLoadFurtherLink=__bind(this.pasteLoadFurtherLink,this),this.enterKeyLoadFurtherLink=__bind(this.enterKeyLoadFurtherLink,this),this.loadFurtherLink=__bind(this.loadFurtherLink,this),this.submitFurtherReading=__bind(this.submitFurtherReading,this),this.deleteFurtherReading=__bind(this.deleteFurtherReading,this),this.cancelFurtherReading=__bind(this.cancelFurtherReading,this),this.startNewFurtherReadingLink=__bind(this.startNewFurtherReadingLink,this),this.showContributeModal=__bind(this.showContributeModal,this),this.markNoteViewed=__bind(this.markNoteViewed,this),this.markNoteRead=__bind(this.markNoteRead,this),this.highlightNote=__bind(this.highlightNote,this),this.init=__bind(this.init,this);var t,e,n;NoteShow.__super__.constructor.apply(this,arguments),/#comments/.test(location.hash)&&(this.goToComment=!0),"#comments"===location.hash&&($("a[href='#comments']").click(),location.hash=location.hash),Maleskine.BrowserDetector.isIE8()&&$(window).width()<=1024&&$(".container").addClass("fix-ie8"),this.notebooksMenuModal.on("show",function(t){return function(){var e,n;return n=t.notebooksMenuModal.find(".panel-heading").outerHeight(),e=$(window).height()-40-n-55,t.notebooksMenuModal.find("ul.list-group").css({"max-height":""+e+"px"})}}(this)),this.submissionModal.on("show",function(t){return function(){var e,n;return n=t.submissionModal.find(".modal-header").outerHeight(),e=$(window).height()-40-n-55,t.submissionModal.find("div.modal-body").css({"max-height":""+e+"px"})}}(this)),this.init(),$(document).on("WeixinJSBridgeReady",function(t){return function(){return WeixinJSBridge.on("menu:share:appmessage",function(){var e,n;return e=t.images.length>0?$(t.images[0]).attr("src"):$("#show-note-container div.people div.avatar img").attr("src"),n={img_url:e,link:t.noteUrl,desc:t.noteAbbr,title:t.title},WeixinJSBridge.invoke("sendAppMessage",n,function(t){return _report("send_msg",t.err_msg)})}),WeixinJSBridge.on("menu:share:timeline",function(){var e,n;return e=t.images.length>0?$(t.images[0]).attr("src"):$("#show-note-container div.people div.avatar img").attr("src"),n={img_url:e,link:t.noteUrl,desc:t.noteAbbr,title:t.title},WeixinJSBridge.invoke("shareTimeline",n,function(t){return _report("send_msg",t.err_msg)})}),WeixinJSBridge.on("menu:share:weibo",function(){return WeixinJSBridge.invoke("shareWeibo",{content:"",url:t.noteUrl},function(t){return _report("send_msg",t.err_msg)})})}}(this)),this.warning.hide(),e=this.warning,n=this.warningText,this.sendMessageButton.click(function(){var t,i,r,o,a,s;return t=$("#message_content").val(),$("#message_content").attr("disabled","disabled"),$(this).attr("disabled","disabled"),r=$(this).text(),$(this).text(I18n.t("button.submitting")),e.hide(),s=$(this).data("send_message_url"),i=$(this).data("mail_to"),o=$(this).data("reply_to"),a=$(this).data("reply_type"),$.post(s,{content:t,reply_to:o,reply_type:a,mail_to:i,format:"json"},function(t){return function(i){return"ok"===i.status?$("#message_content").val(""):(n.text(""+I18n.t("button.submit_failed")+", "+i.error[0]),e.show()),$("#message_content").attr("disabled",null),$(t).attr("disabled",null),$(t).text(r)}}(this))}),$(window).scroll(function(t){return function(){var e;return e=$(window).scrollTop(),e>2e3?t.goTopButton.removeClass("hide-go-top"):t.goTopButton.addClass("hide-go-top")}}(this)),this.noteContainer.on("pjax:success",function(t){return function(){return t.refreshElements(),document.title=t.noteTitle.text(),t.init()}}(this)),t=null,this.collectionSearch.userChange(function(e){return function(){return null!==t&&clearTimeout(t),t=setTimeout(function(){var t;return t=e.collectionSearch.val(),$.post(e.collectionSearch.data("search-collections-url")+("&&search_term="+t))},250)}}(this)),this.initAddList()}return __extends(NoteShow,_super),NoteShow.prototype.elements={"div.go-top":"goTopButton","#myModal":"readModeModal","#notebooks-menu":"notebooksMenuModal","ul.list-group a":"notes","a.notebooks-menu-btn":"notebooksMenuButton","#user-editor-actions":"submissionModal","#show-note-container":"noteContainer","h1.title":"noteTitle","div.show-content":"noteContent","a.write-letter":"messageButton","div.meta-bottom":"metaBottom","div.show-content img":"images","#send_message_button":"sendMessageButton","#write-letter span.warning":"warning","#write-letter span.warning > span.warning-text":"warningText","input#search_term":"collectionSearch","#further-readings-list":"furtherReadingsList","#further-reading-line":"furtherReadingsTitle","#further-reading-description":"furtherReadingDescription"},NoteShow.prototype.events={"show #user-editor-actions":"showContributeModal","click #further-reading-new-prompt":"startNewFurtherReadingLink","click #load-further-reading":"loadFurtherLink","click #cancel-further-reading":"cancelFurtherReading","click #submit-further-reading":"submitFurtherReading","click #delete-further-reading":"deleteFurtherReading","keypress #further-reading-link-text":"enterKeyLoadFurtherLink","paste #further-reading-link-text":"pasteLoadFurtherLink","mouseover .further-reading-states>li":"showStateDropdown","mouseout .further-reading-states>li":"hideStateDropdown"},NoteShow.prototype.init=function(){var $likeButton,$othersButton,$othersDropdown,$othersItem,$weiboAndTwitter,assistButtons,authorName,img,module,others,popline,sns,snses,url,_i,_j,_k,_l,_len,_len1,_len2,_len3,_ref,_ref1,_ref2,_ref3;for($likeButton=this.$("a.like-button"),$likeButton.on("click",function(t){return $(this).parent().hasClass("load")?(t.preventDefault(),t.stopPropagation()):void 0}),$likeButton.on("ajax:beforeSend",function(){return $(this).parent().addClass("load")}),$likeButton.on("ajax:complete",function(){return $(this).parent().removeClass("load")}),_ref=$.popline.instances,_i=0,_len=_ref.length;_len>_i;_i++)popline=_ref[_i],popline.destroy();if($.popline.instances=[],window.Zepto&&(assistButtons=Zepto(".show-contents, .back, .right-corner-nav, .shrink, .navbar-user, .wrap-btn, .notebooks-menu-btn"),Zepto(".article").on("tap",function(){return assistButtons.toggleClass("phone-hiding")}),Zepto(window).scroll(function(){return Zepto(window).scrollTop()>50?assistButtons.addClass("phone-hiding"):assistButtons.removeClass("phone-hiding")})),this.title=$.trim(this.noteTitle.html()),this.noteUrl=window.location.href.split("?")[0],this.noteSlug=this.getShowNoteSlugFromUrl(),this.is_author_self=Boolean(this.metaBottom.data("is-self")),this.is_signed_in=Boolean(this.metaBottom.data("is-signed-in")),this.authorNameWeibo=this.metaBottom.data("author-weibo"),this.authorNameTwitter=this.metaBottom.data("author-twitter"),this.noteImage=this.metaBottom.data("image"),this.noteAbbr=$("#short-abbr").html(),this.noteImage)this.imageUrls=[this.noteImage];else for(this.imageUrls=[],_ref1=this.images,_j=0,_len1=_ref1.length;_len1>_j;_j++)img=_ref1[_j],this.imageUrls.push($(img).attr("src"));for(this.markNoteViewed(),this.is_signed_in&&!this.is_author_self&&$.popline.addButton({message:{iconClass:"icon-envelope",mode:"view",action:function(t){return function(){var e,n;return _czc.push(["_trackEvent","note-show","popline-message","","",""]),e=$.popline.current.currentSelection.text,e.length>197&&(e=""+e.slice(0,198)+"..."),e=encodeURIComponent(e),n=t.messageButton.attr("href"),window.open(""+n+"&quote="+e)}}(this)}}),$.popline.addButton({share:{iconClass:"icon-share",mode:"view",buttons:{weibo:{iconClass:"icon-weibo",mode:"view",action:function(_this){return function(event){var quote,url;return _czc.push(["_trackEvent","note-show","popline-weibo","","",""]),quote=$.popline.current.currentSelection.text,url=Maleskine.ShareScripts.share("weibo",_this.title,quote,_this.noteUrl,_this.authorNameWeibo,_this.is_author_self,_this.imageUrls),eval(url)}}(this)},twitter:{iconClass:"icon-twitter",mode:"view",action:function(_this){return function(event){var quote,url;return _czc.push(["_trackEvent","note-show","popline-twitter","","",""]),quote=$.popline.current.currentSelection.text,quote=$.popline.current.currentSelection.text,url=Maleskine.ShareScripts.share("twitter",_this.title,quote,_this.noteUrl,_this.authorNameTwitter,_this.is_author_self,_this.imageUrls),eval(url)}}(this)}}}}),this.startReadingTime=(new Date).getTime(),this.readScrollLimit=this.metaBottom.offset().top,this.noteContent.popline({mode:"view",position:"relative",top:this.noteContent.offset().top,bottom:this.noteContent.offset().top+this.noteContent.height()}),this.el.pjax("a[data-pjax]","#show-note-container"),this.highlightNote(this.getShowNoteSlugFromUrl()),$weiboAndTwitter=$("ul.share-note-text"),snses="",_ref2=["weibo","twitter"],_k=0,_len2=_ref2.length;_len2>_k;_k++)sns=_ref2[_k],authorName=this.metaBottom.data("author-"+sns),url=Maleskine.ShareScripts.share(sns,this.title,null,this.noteUrl,authorName,this.is_author_self,this.imageUrls),snses=""+snses+'<li><a href="'+url+"\"><i class='icon-"+sns+"'></i></a></li>";for($weiboAndTwitter.append(snses),$othersButton=$("<a href='javascript:void(0)' data-toggle='dropdown' class='share-btn'><i class='icon-ellipsis-horizontal'></i></a>"),$othersDropdown=$("<ul class='dropdown-menu'></ul>"),this.noteImage&&$othersDropdown.append("<li><a href='"+this.noteImage+"' target='_blank'><i class='icon-download'></i>"+I18n.t("reading.download_changweibo_image")+"</a></li>"),others="",_ref3=["tweibo","qzone","douban","facebook","google_plus","renren"],_l=0,_len3=_ref3.length;_len3>_l;_l++)sns=_ref3[_l],url=Maleskine.ShareScripts.share(sns,this.title,null,this.noteUrl,authorName,this.is_author_self,this.imageUrls),others=""+others+'<li><a href="'+url+"\"><img src='"+Maleskine.CommonImages.social_icon(sns,32,32)+"'> "+I18n.t("reading.social_sharing.share_to_label."+sns)+"</a></li>";return $othersDropdown.append(others),$othersItem=$("<li></li>"),$othersItem.append($othersButton).append($othersDropdown),$weiboAndTwitter.append($othersItem),module=new Maleskine.CommentsList({el:this.el.find("#comments")}),$.getJSON(Routes.note_further_readings_path(this.noteSlug)).done(function(t){return function(e){var n,i,r,o;if(e.length>0){for(t.furtherReadingsTitle.show(),o=0,r=e.length;r>o;o++)i=e[o],t.furtherReadingsList.append(JST.render("note/further_reading_item",i));if(n=t.getURLParmeter("further_reading"))return t.scrollToAnchor("further_reading_"+n)}}}(this)),this.furtherReadingsList.on("click",".state-item",function(t){return function(e){return t.setFurtherReadingState($(e.currentTarget))}}(this)),$("body").on("click",".undo",function(t){return function(e){var n,i,r;return t.furtherReadingsTitle.show(),r=$(e.currentTarget).data("state"),t.removeFurtherReadingItem&&"dismiss"!==r&&clearTimeout(t.removeFurtherReadingItem),n=$(e.currentTarget).data("further-reading-id"),i=t.furtherReadingsList.find("li#further_reading_"+n),t.setFurtherReadingState(i.find("li[data-state='"+r+"']")),$(e.currentTarget).parents("ul").remove()}}(this))},NoteShow.prototype.highlightNote=function(t){return this.notes.removeClass("active"),this.notes.filter("[data-note-slug="+t+"]").addClass("active")},NoteShow.prototype.getShowNoteSlugFromUrl=function(){var t,e,n;return t=/p\/([a-zA-Z0-9]{6,12})/,n=window.location.pathname,e=n.match(t),e?e[1]:0},NoteShow.prototype.markNoteRead=function(){var t,e;return e=Math.floor(((new Date).getTime()-this.startReadingTime)/1e3),t=this.visit_data,t.reading_time=e,$.post("/notes/"+this.noteSlug+"/mark_read",t)},NoteShow.prototype.markNoteViewed=function(){var t,e,n,i;for(n=/([^&=]+)=?([^&]*)/g,e=window.location.search.slice(1,+window.location.search.length+1||9e9),this.visit_data={},this.visit_data.token=Maleskine.Utils.secureRandom(64),null!=document.referrer&&document.referrer.length>0&&(this.visit_data.referrer=document.referrer);t=n.exec(e);)("utm_source"===(i=t[1])||"utm_medium"===i||"utm_term"===i||"utm_content"===i||"utm_campaign"===i)&&(this.visit_data[t[1]]=t[2]);return $.post("/notes/"+this.noteSlug+"/mark_viewed",this.visit_data),null==this.goToComment?$(document).scrollTop()+$(window).height()>=this.readScrollLimit?window.setTimeout(function(t){return function(){return t.markNoteRead()}}(this),1500):$(window).on("scroll.markread",function(t){return function(){return $(document).scrollTop()+$(window).height()>=t.readScrollLimit?($(window).off("scroll.markread"),t.markNoteRead()):void 0}}(this)):void 0},NoteShow.prototype.showContributeModal=function(t){var e,n;return $(".modal-body #search_term").val(""),e=$(t.currentTarget).data("user-slug"),n=$(t.currentTarget).data("note-id"),$.getJSON(Routes.editable_collections_user_path(e,{note_id:n,format:"json"}),function(t){return function(e){var i,r;return r=$("ul.add-list"),r&&r.length>0&&r[0]?(r[0].reset=function(){return r.empty().append(JST.render("note/collection",{collections:e.collections,note_id:n})),r[0].setListItem()},r[0].reset(),i=t.submissionModal.find(".search-query"),i.focus()):void 0}}(this))},NoteShow.prototype.startNewFurtherReadingLink=function(t){return $(t.currentTarget).hide(),$("#further-reading-form").replaceWith(JST.render("note/further_reading_link")),$("#further-reading-form").show(),this.selectText($("#further-reading-link-text"))},NoteShow.prototype.cancelFurtherReading=function(t){return $(t.currentTarget).parent().empty().removeClass("active"),$("#further-reading-new-prompt").show()},NoteShow.prototype.deleteFurtherReading=function(t){var e,n;return n=$(t.currentTarget).parents("li"),e=$(t.currentTarget).data("further-reading-id"),$.ajax({url:Routes.note_further_reading_path(this.noteSlug,e),type:"DELETE",dataType:"json"}).done(function(t){return function(){return n.remove(),0===t.furtherReadingsList.children().length&&t.furtherReadingsTitle.hide(),t.notyInfo(I18n.t("reading.further_reading.delete_success"))}}(this))},NoteShow.prototype.submitFurtherReading=function(){var t,e,n,i;return e=this.getShowNoteSlugFromUrl(),n=$("#further-reading-title").text(),t=$("#further-reading-description").text(),i=$("#further-reading-url").attr("href"),$.post(Routes.note_further_readings_path(e),{further_reading:{title:n,description:t,url:i}},function(t){return function(e){return t.furtherReadingsTitle.show(),t.furtherReadingsList.append(JST.render("note/further_reading_item",e)),$("#further-reading-form").empty().removeClass("active"),$("#further-reading-new-prompt").show()}}(this)).fail(function(t){return function(e){return t.notyError($.parseJSON(e.responseText).errors[0])}}(this))},NoteShow.prototype.loadFurtherLink=function(){var t;return t=$.trim($("#further-reading-link-text").text()),t.length>0?(/^(http(s?):\/\/|www)/.test(t)||$("#further-reading-link-text").text("http://"+t),$.ajax({url:Routes.load_reading_url_path({url:t}),dataType:"json",beforeSend:function(){return function(){return $("#loader").show()}}(this)}).done(function(t){return function(e){var n,i,r;return r=$("#further-readings").data("user-slug"),i=$("#further-readings").data("user-nickname"),$("#further-reading-form").replaceWith(JST.render("note/further_reading_content",{data:e,slug:r,nickname:i})),n=$("#further-reading-description"),t.selectText(n),n.on("keypress",function(e){var n;return n=e.keyCode||e.which,13===n?t.submitFurtherReading():void 0})}}(this)).fail(function(t){return function(){return t.notyInfo(I18n.t("reading.further_reading.load_link_error"))}}(this)).always(function(){return function(){return $("#loader").hide()}}(this))):void 0},NoteShow.prototype.enterKeyLoadFurtherLink=function(t){return 13===t.which?(this.loadFurtherLink(),t.preventDefault()):void 0},NoteShow.prototype.pasteLoadFurtherLink=function(){return setTimeout(function(t){return function(){return t.loadFurtherLink()}}(this),100)},NoteShow.prototype.showStateDropdown=function(t){return $(t.currentTarget).parent().children().show()},NoteShow.prototype.hideStateDropdown=function(t){return $(t.currentTarget).parent().children(".hide").hide()},NoteShow.prototype.setFurtherReadingState=function(t){var e,n,i,r,o;return n=t.parents("li"),e=t.parent().data("further-reading-id"),i=n.data("can-be-dismissed"),r=t.parent().data("origin-state"),o=t.data("state"),t.parent().replaceWith(JST.render("note/further_reading_states",{id:e,state:o,can_be_dismissed:i})),n.show(),"dismiss"===o&&(n.hide(),1===this.furtherReadingsList.children().length&&this.furtherReadingsTitle.hide()),$.post(Routes.update_further_reading_state_path({format:"json"}),{note_id:this.noteSlug,id:e,state:o},function(t){return function(){var i;return t.removeFurtherReadingItem=setTimeout(function(){return"dismiss"===o?n.remove():void 0},5e3),i=I18n.t("reading.further_reading.states."+o),noty({text:I18n.t("reading.further_reading.undo_link",{state:i,id:e,originState:r}),layout:"topCenter",type:"information",timeout:4800,closeWith:[],theme:"maleskineTheme"})}}(this)).fail(function(t){return function(i){return n.find(".further-reading-states").replaceWith(JST.render("note/further_reading_states",{id:e,state:r})),t.notyError($.parseJSON(i.responseText).errors[0]),"dismiss"===o?(t.furtherReadingsList.children().length>0&&t.furtherReadingsTitle.hide(),n.show()):void 0}}(this))},NoteShow.prototype.selectText=function(t){var e,n,i;return e=t[0],document.body.createTextRange?(n=document.body.createTextRange(),n.moveToElementText(e),n.select()):window.getSelection?(i=window.getSelection(),n=document.createRange(),n.selectNodeContents(e),i.removeAllRanges(),i.addRange(n)):void 0},NoteShow.prototype.initAddList=function(){var t,e,n;return e=-1,n=$("ul.add-list"),n&&n.length>0&&n[0]?(t=function(){return n.find("li.selected").removeClass("selected"),e>-1?$(n.find("li")[e]).addClass("selected"):void 0},n[0].setListItem=function(){var i,r,o,a;for(e=-1,r=n.find("li"),o=0,a=r.length;a>o;o++)i=r[o],i=$(i),i[0]._self=i,i.on("click",function(){return function(t){var e,n;for(e=t.target;"li"!==e.tagName.toLowerCase()&&e.parentElement;)e=e.parentElement;return"li"!==e.tagName.toLowerCase()||e.querySelectorAll("a.delete").length>0?void 0:(n=e.querySelector("h5"),n.innerHTML=n.innerHTML+'&nbsp;&nbsp;&nbsp;&nbsp;<img alt="Tiny" class="loader-tiny" src="'+Maleskine.CommonImages.loader("tiny")+'" />')}}(this));return t()},this.collectionSearch.on("keydown",function(i){var r,o,a;if(40===i.keyCode||38===i.keyCode||13===i.keyCode)return 13===i.keyCode?(r=n.find("li.selected"),a=r.find("a.delete"),void(a.length>0?a.trigger("click"):r.find("a").trigger("click"))):(o=n.find("li"),38===i.keyCode?(e--,-1>e&&(e=-1)):40===i.keyCode&&(e++,e>=o.length&&(e=-1)),t(),i.preventDefault())})):void 0},NoteShow}(Maleskine.BaseModule)}.call(this);