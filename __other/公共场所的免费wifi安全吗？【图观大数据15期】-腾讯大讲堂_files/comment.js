function Comments(f,e,b,g,c,d,a){var h=this;this.comment_obj_type=12;this.word_limit=d;this.min_word_limit=5;this.user_id="";this.id=f;this.obj_type=e;this.obj_id=b;this.parent_id=g;this.limit=c;this.a_code_length=4;this.order=a;h.length_validate=false;h.too_short=true;this.url=global.context+"/comment/index?obj_type="+h.obj_type+"&obj_id="+h.obj_id+"&parent_id="+this.parent_id+"&limit="+h.limit+"&order="+h.order;if(g==0){this.comment_item_content=$("#"+this.id+">.comments>.comment-item-content");this.textarea=$("#"+this.id+">.comments .comment-input")}else{this.comment_item_content=$("#"+this.id+" .reply-item-content");this.textarea=$("#"+this.id+" .comment-input")}this.word_limit_wrapper=$("#"+this.id+" .remain-count");this.a_code_input_wrapper=$("#"+this.id+" .authenticode-wrapper");this.textarea_height=this.textarea.css("height");$("#"+this.id+" .comment-submit").click(function(){var m=g;var j=$(this).attr("data-to");if(typeof j!="undefined"){m=j}if($(this).hasClass("disable")){return false}if(h.length_validate==false){if(h.too_short==true){h.word_limit_wrapper.html("评论内容过短")}h.highlight_textarea();return false}url=global.context+"/comment/add/";var i=get_config("USER");var n=new Object();n.obj_id=b;n.obj_type=e;n.parent_id=m;n.a_code=h.a_code_input_wrapper.find(".a_code-input").val();if(typeof i!="undefined"&&typeof i.token!="undefined"){n.token=i.token}var k=this;var l=$(this).parent().find(".comment-input");n.content=$.trim(l.val());param_hash(n);$.ajax({type:"post",url:url,data:n,dataType:"json",beforeSend:function(){l.css({background:'url("../img/loading.gif") no-repeat center'});l.attr("disabled","disabled")},error:function(){l.css({background:"none"});l.removeAttr("disabled")},success:function(s){l.css({background:"none"});l.removeAttr("disabled");var o=get_config("USER");o.token=s.token;add_config("USER",o);if(s.code==0){$(h.textarea).css("height",h.textarea_height);h.a_code_input_wrapper.html("");l.val("");h.word_limit_wrapper.html("");$("#"+h.id+" .pagination").ajaxPagination({success:$.proxy(h,"list_comments"),url:h.url});h.length_validate=false;h.a_code_input_wrapper.hide();var q=$(k).attr("comment-id");var p=$(k).attr("comment-to");if(typeof p!="undefined"&&typeof q!="undefined"){$(k).attr("data-to",q);$(h.textarea).attr("placeholder",p)}}else{if(s.code==301){show_ajax_login_dialog()}else{if(s.code==302){var r=global.context+"/profile?ref_url="+encodeURIComponent(location.href);location.href=r;return false}else{if(s.code==402){$(".authenticode-wrapper").html("");h.add_a_code_input();h.a_code_input_wrapper.show();var t=h.a_code_input_wrapper.find(".a_code-input");t.addClass("error");setTimeout(function(){t.removeClass("error")},500)}else{if(s.code==401){$(".authenticode-wrapper").html("");h.add_a_code_input();h.a_code_input_wrapper.show()}else{if(s.code==403){l.val("您已被禁止发表内容");l.addClass("disable");l.attr("disabled","disabled");$("#"+h.id+" .comment-submit").addClass("disable")}else{if(s.code==404||s.code==405){$(h.textarea).css("height",h.textarea_height);h.a_code_input_wrapper.html("");l.val("");h.word_limit_wrapper.html("");l.focus();h.length_validate=false;h.a_code_input_wrapper.hide();alert(s.message||"评论内容不合法")}}}}}}}}})});$("#"+this.id+" .comment-input").bind("keyup change",function(){var i=$("#"+h.id+" .copy");var k=$.trim($(this).val()).length;if(h.parent_id==0){h.word_limit_wrapper.fadeIn(500);if(k<h.min_word_limit){h.length_validate=false;h.too_short=true;h.word_limit_wrapper.html("发言请遵守社区约定，还可输入 <b>"+(h.word_limit-k)+"</b> 字")}else{if(h.word_limit<k){h.length_validate=false;h.too_short=false;h.word_limit_wrapper.addClass("error");h.word_limit_wrapper.html("超出"+(k-h.word_limit)+"字")}else{h.length_validate=true;h.too_short=false;h.word_limit_wrapper.removeClass("error");h.word_limit_wrapper.html("发言请遵守社区约定，还可输入 <b>"+(h.word_limit-k)+"</b> 字")}}}else{if(k<h.min_word_limit){h.length_validate=false}else{if(h.word_limit<k){$(this).val($(this).val().substr(0,h.word_limit));h.length_validate=true}else{h.length_validate=true}}}i.val($(this).val()+"一一");var j=i[0].scrollHeight;if($.browser.mozilla){$(this).css("height",j+"px")}else{j=j-parseInt($(this).css("padding-top"))-parseInt($(this).css("padding-bottom"));$(this).css("height",j+"px")}});$("#"+this.id+" .comment-input").focus(function(){$(this).parent().addClass("focus")});$("#"+this.id+" .comment-input").blur(function(){$(this).parent().removeClass("focus")})}Comments.prototype={constructor:Comments,loading:function(){if(this.comment_item_content.html()==""){this.comment_item_content.html('<div class="comment-loading"><p>正在努力拉取评论，请稍候...</p></div>')}},error:function(){this.comment_item_content.html('<div class="comment-error"><p>网络出现了问题，请<a href="javascript:void(0);" onclick="location.reload();">刷新</a>重试</p></div>')},list_comments:function(b){if(typeof _config.USER=="undefined"||_config.USER["id"]==0){$(this.textarea).css("cursor","pointer");$(this.textarea).click(function(){if(typeof _config.USER=="undefined"||_config.USER["id"]==0){show_ajax_login_dialog(build_query(location.href,{locate:"comment"}));return false}})}else{this.user_id=_config.USER["id"]}this.comment_item_content.html("");var d=this;if(d.parent_id==0){for(var a in b.comments){this.add_comment(b.comments[a],b.admin)}}else{for(var a in b.comments){this.add_reply(b.comments[a],b.admin)}}this.comment_item_content.find(".comment-item:last").addClass("last-item");var c=$(".comments-header-wrapper .commnet-count");c.html(b.pagination.sum);if(d.parent_id!=0){var c=$("#"+this.id+">.comment-item .commnet-count");if(b.pagination.total>0){str="("+b.pagination.total+")";c.html(str)}else{c.html("")}}$(this.comment_item_content).find(".del-btn").click(function(){if(!confirm("确定删除这条评论吗？")){return false}var e=global.context+"/comment/del/";var f=$(this).attr("data-to");var g=new Object();g.comment_id=f;$.ajax({type:"post",url:e,data:g,dataType:"json",error:function(){alert("由于网络问题，删除出错.请稍候再试.")},success:function(h){if(h.code==0){$("#"+d.id+" .pagination").ajaxPagination({success:$.proxy(d,"list_comments"),url:d.url})}}})});$(this.comment_item_content).find(".ban-btn").click(function(){$("#dialog-ban-time-select .ban-id").val($(this).attr("data-to"));$("#dialog-ban-time-select").dialog("open")});if(d.parent_id==0){$(this.comment_item_content).find(".show-reply-input").click(function(){var i=$("#comment_reply_wrapper_"+$(this).attr("data-to"));i.toggle("fast");var h=i.find(".reply-item-content");var e=global.context+"/comment/replys/";var j=new Object();j.comment_id=$(this).attr("data-to");this_btn=this;if(h.html()==""){var g=new Comments("comment_"+j.comment_id,d.obj_type,d.obj_id,j.comment_id,10,d.word_limit,"ASC");$("#comment_"+j.comment_id+" .pagination").ajaxPagination({success:$.proxy(g,"list_comments"),loading:$.proxy(g,"loading"),error:$.proxy(g,"error"),url:g.url})}var f=$(this).parents("li").find(".comment-reply-wrapper");if(f.length>0){f.find(".reply-input").attr("placeholder","回复 "+htmlspecialchars($(this).attr("comment-nickname"))+"： ");f.find(".reply-submit").attr("data-to",$(this).attr("data-to"))}});$(this.comment_item_content).find(".hide-replys-wrapper").click(function(){$(this).parent().parent().find(".replys-header").show();$(this).parent().hide()})}else{$(this.comment_item_content).find(".reply-btn").click(function(){d.textarea.focus();$(d.textarea).attr("placeholder","回复 "+htmlspecialchars($(this).attr("comment-nickname"))+"： ");$(d.textarea).parent().parent().find(".reply-submit").attr("data-to",$(this).attr("comment-id"))})}},add_comment:function(c,a){var b=Array('<li id="comment_'+c.id+'" >','<div class="comment-item">','<div class="clearfix">','<div class="comment-avatar">','<a href="'+get_config("DZ_PATH")+"/space-uid-"+c.created_by+'.html"><img width="50" src="'+(c.avatar_image&&c.avatar_image.length>0?c.avatar_image:global.context+"/img/data/users/avatar.jpg")+'" /></a>',"</div>",'<div class="comment-detail-wrapper">','<div class="comment-detail">','<a class="user-name" href="'+get_config("DZ_PATH")+"/space-uid-"+c.created_by+'.html">'+htmlspecialchars(c.username)+"</a>："+c.content+' <span class="comment-ago">&nbsp;&nbsp;'+c.ago+"</span>","</div>",'<div class="comment-control">','<div class="float-left">',"</div>",'<div class="float-left reply" >','<a class="show-reply-input" data-to="'+c.id+'" count="'+c.reply_count+'" comment-nickname="'+htmlspecialchars(c.username)+'">回复<span class="commnet-count">'+(c.reply_count==0?"":"("+c.reply_count+")")+"</span></a>"+(c.created_by==this.user_id||a==true?'<a class="del-btn" data-to="'+c.id+'" >删除</a>':""),""+(a==true?'<a class="ban-btn" data-to="'+c.id+'" >禁言</a>':""),"</div>","</div>","</div>","</div>",'<div class="comment-reply-wrapper" id="comment_reply_wrapper_'+c.id+'">','<div class="grey-arrow"></div>','<div class="reply-input-wrapper" id="comment_reply_input_'+c.id+'">','<div class="reply-wrapper float-left">','<textarea class="reply-input comment-input" placeholder="回复 '+htmlspecialchars(c.username)+'： "></textarea>',"</div>",'<div class="auto-height-wrapper">','<textarea class="reply-input comment-input copy" placeholder="回复 '+htmlspecialchars(c.username)+'： "></textarea>',"</div>",'<a class="reply-submit comment-submit" data-to="'+c.id+'" comment-id="'+c.id+'" comment-to="'+htmlspecialchars(c.username)+'">回复</a>',"</div>",'<div class="comment-control-wrapper">','<div class="remain-count"></div>','<div class="authenticode-wrapper"></div>',"</div>",'<div class="reply-item-wrapper">','<ul class="reply-item-content">',"</ul>",'<div class="pagination">',"<div></div>","</div>","</div>","</div>","<div>","</li>");this.comment_item_content.append(b.join(""))},add_reply:function(reply,admin){var reply_text="";if(reply.parent_id>0){try{var reply_content=eval(reply.content);if(reply.parent_id==reply.reply_id){reply_text+='<a class="user-name" href="'+get_config("DZ_PATH")+"/space-uid-"+reply.created_by+'.html">'+htmlspecialchars(reply.username)+"</a>："}else{reply_text+='<a class="user-name" href="'+get_config("DZ_PATH")+"/space-uid-"+reply.created_by+'.html">'+htmlspecialchars(reply.username)+"</a> 回复 ";reply_text+='<a class="user-name" href="'+get_config("DZ_PATH")+"/space-uid-"+reply_content[0]+'.html">'+reply_content[1]+"</a>";reply_text+="："}reply_text+=reply_content[2]}catch(e){reply_text+='<a class="user-name" href="'+get_config("DZ_PATH")+"/space-uid-"+reply.created_by+'.html">'+htmlspecialchars(reply.username)+"</a>：";if(reply.content){reply_text+=reply.content}}}else{reply_text+=reply.content}reply_text+='<span class="comment-time-ago">&nbsp;&nbsp;'+reply.ago+" </span>";var html_str=Array('<li id="reply_'+reply.id+'" >','<div class="comment-item reply">','<div class="comment-avatar reply">','<a href="'+get_config("DZ_PATH")+"/space-uid-"+reply.created_by+'.html"><img src="'+(reply.avatar_image&&reply.avatar_image.length>0?reply.avatar_image:global.context+"/img/data/users/avatar.jpg")+'" width="40" /></a>',"</div>",'<div class="comment-detail-wrapper reply">','<div class="comment-detail">',reply_text,"</div>","</div>",'<div class="comment-control">',"<div>",'<a class="reply-btn" href="javascript:void(0);" data-to="'+reply.id+'" comment-id="'+reply.id+'" comment-nickname="'+htmlspecialchars(reply.username)+'">回复</a>',"</div>",'<div class="reply">',(reply.created_by==this.user_id||admin==true?'<a class="del-btn" href="javascript:void(0);" data-to="'+reply.id+'">删除</a>':""),"</div>",'<div class="reply">',""+(admin==true?'<a class="ban-btn" data-to="'+reply.id+'" > 禁言 </a>':""),"</div>","</div>","</div>","</li>");this.comment_item_content.append(html_str.join(""))},highlight_textarea:function(){this.textarea.focus();this_textarea=this.textarea.parent();this_textarea.addClass("error");setTimeout(function(){this_textarea.removeClass("error")},500)},highlight_a_code:function(){var a=this.a_code_input_wrapper.find(".a_code-input");a.focus();a.addClass("error");setTimeout(function(){a.removeClass("error")},500)},add_a_code_input:function(){if(this.a_code_input_wrapper.html()==""){$(".authenticode-wrapper").html("");var b="?key="+this.comment_obj_type+"&code="+Math.random();var a=Array('<p class="float-left">请输入验证码:</p>','<div class="float-left"><img class="a_code" alt="看不清？点击换一张" title="看不清？点击换一张" src="'+global.context+"/user/get_authenticode"+b+'" onclick="refresh_a_code(this)"></div>','<input maxlength="'+this.a_code_length+'" class="a_code-input float-left"  />','<label class="info-icon float-left"></label>');this.a_code_input_wrapper.html(a.join(""));this.a_code_input_wrapper.show();this_obj=this;if($.browser.msie){$(".a_code-input").on("keyup",function(){this_obj.set_a_code_status(this)})}else{$(".a_code-input").on("input",function(){this_obj.set_a_code_status(this)})}}},set_a_code_status:function(c){if($(c).val().length>=this.a_code_length){url=global.context+"/user/ajax_check_authenticode/";var d=new Object();d.a_code=$(c).val();d.key=this.comment_obj_type;var b=$(c).siblings(".info-icon");var a=$(c);$.ajax({type:"post",url:url,data:d,dataType:"json",beforeSend:function(){b.addClass("loading");a.attr("disabled","disabled");b.show()},error:function(){a.removeAttr("disabled");b.show()},success:function(e){if(e.code==0){b.removeClass("loading");b.removeClass("error");b.addClass("valid");a.removeAttr("disabled");b.show()}else{b.removeClass("loading");b.removeClass("valid");b.addClass("error");a.removeAttr("disabled");b.show()}}})}}};function refresh_a_code(a){a.src=build_query(a.src,{code:Math.random()});$(a).siblings(".info-icon").show()}jQuery(function(a){a("#dialog-ban-time-select").dialog({autoOpen:false,closeOnEscape:false,modal:true,resizable:false,draggable:false,width:230,height:200,dialogClass:"ban-time-select",buttons:{"确定":function(){var c=global.context+"/comment/ban_user/";var d=a(this).find(".ban-id").val();var b=a(this).find(".ban-time-select:checked").val();var e=new Object();e.comment_id=d;e.time_select=b;a.ajax({type:"post",url:c,data:e,dataType:"json",error:function(){alert("由于网络问题，删除出错.请稍候再试.")},success:function(f){if(f.code==0){alert("禁言成功")}}});a(this).dialog("close")},"取消":function(){a(this).dialog("close")}},open:function(b,c){a(".ui-widget-overlay").css("background","#333").css("opacity","0.5")}})});